<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Portfolio</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#020617;color:#e5e7eb;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid #1e293b;margin-bottom:14px}
button{border:none;padding:10px 14px;border-radius:10px;font-weight:900;cursor:pointer;background:#38bdf8;color:#020617}
.box{border:1px solid #1e293b;border-radius:12px;padding:14px;background:#020617;margin-bottom:16px}
h2{margin:0;font-size:18px}
.big{font-size:30px;font-weight:1000;margin-top:10px}
.small{color:#94a3b8;font-size:12px;margin-top:6px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.card{border:1px solid #1e293b;border-radius:12px;padding:12px}
.ok{color:#22c55e}
.err{color:#f87171}
.neutral{color:#38bdf8}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #1e293b;padding:10px;font-size:13px;word-break:break-word}
th{background:#0b1224}
.progress{height:8px;border-radius:999px;background:#1e293b;margin-top:8px;overflow:hidden}
.bar{height:8px;background:#22c55e}
.barLoss{height:8px;background:#f87171}
.tag{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;margin-top:8px}
.tagProfit{background:#22c55e;color:#020617}
.tagLoss{background:#f87171;color:#020617}
.tagFlat{background:#38bdf8;color:#020617}

.chartWrap{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px}
.chartCard{flex:1;min-width:260px;border:1px solid #1e293b;border-radius:12px;padding:12px}
canvas{width:100%;max-width:100%;height:260px;border-radius:12px;background:#020617}
.legend{margin-top:10px}
.legendItem{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px}
.dot{width:12px;height:12px;border-radius:999px;display:inline-block}
</style>
</head>

<body>

<header>
  <strong>My Portfolio</strong>
  <button onclick="goDashboard()">Dashboard</button>
</header>

<div class="box">
  <h2>Total Portfolio</h2>
  <div id="total" class="big">--</div>
  <div id="email" class="small">Loading…</div>

  <div class="grid">
    <div class="card">
      <div class="small">Total Invested</div>
      <div id="invested" style="font-size:20px;font-weight:1000;margin-top:6px;">--</div>
    </div>
    <div class="card">
      <div class="small">Total Profit / Loss</div>
      <div id="pnl" style="font-size:20px;font-weight:1000;margin-top:6px;">--</div>
      <div id="roi" class="small"></div>
    </div>
  </div>
</div>

<div class="box">
  <h2>Charts</h2>

  <div class="chartWrap">
    <div class="chartCard">
      <strong>Allocation (Pie)</strong>
      <div class="small">Shows percentage distribution per asset</div>
      <canvas id="pieChart" width="400" height="260"></canvas>
      <div id="pieLegend" class="legend"></div>
    </div>

    <div class="chartCard">
      <strong>Performance (Growth)</strong>
      <div class="small">Compares invested vs current value</div>
      <canvas id="barChart" width="400" height="260"></canvas>
      <div class="small">Bars: Invested vs Current Value</div>
    </div>
  </div>
</div>

<div class="box">
  <h2>Holdings (P&L)</h2>
  <div id="msg" class="small">Loading…</div>

  <table>
    <thead>
      <tr>
        <th>Asset</th>
        <th>Amount</th>
        <th>Buy Price</th>
        <th>Current Price</th>
        <th>Invested</th>
        <th>Value</th>
        <th>P/L</th>
        <th>ROI</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

function goDashboard(){ window.location.href="user-dashboard.html"; }

let userEmail="";

function money(n){
  const v = Number(n||0);
  return "$" + v.toFixed(2);
}
function pct(n){
  const v = Number(n||0);
  return v.toFixed(2) + "%";
}

init();

async function init(){
  const { data:userData } = await supabaseClient.auth.getUser();
  if(!userData.user){
    document.body.innerHTML="<h2 style='color:white'>You must login first.</h2>";
    return;
  }

  userEmail = userData.user.email;
  document.getElementById("email").innerHTML=`Logged in as: <span class="ok">${userEmail}</span>`;

  const { data:holdings, error } = await supabaseClient
    .from("portfolios")
    .select("*")
    .eq("user_email", userEmail)
    .order("created_at",{ascending:false});

  if(error){
    document.getElementById("msg").innerHTML="<span class='err'>"+error.message+"</span>";
    return;
  }

  if(!holdings || holdings.length===0){
    document.getElementById("total").innerHTML="$0.00";
    document.getElementById("invested").innerHTML="$0.00";
    document.getElementById("pnl").innerHTML="$0.00";
    document.getElementById("roi").innerHTML="";
    document.getElementById("msg").innerHTML="<span class='err'>No holdings yet. Admin must add holdings in Portfolio Manager.</span>";
    document.getElementById("rows").innerHTML="";
    drawPie([],[]);
    drawBars([]);
    return;
  }

  const idsMap = { btc:"bitcoin", eth:"ethereum", usdt:"tether" };

  // Fetch prices (for assets present)
  const uniqueAssets = [...new Set(holdings.map(h => (h.asset||"").toLowerCase()))];
  const ids = uniqueAssets.map(a => idsMap[a]).filter(Boolean).join(",");

  const pricesRes = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`);
  const prices = await pricesRes.json();

  // Table + totals
  let totalValue=0;
  let totalInvested=0;

  const tbody=document.getElementById("rows");
  tbody.innerHTML="";

  // For charts
  const pieLabels=[];
  const pieValues=[];
  const bars=[]; // {asset, invested, value}

  holdings.forEach(h=>{
    const asset=(h.asset||"").toLowerCase();
    const amount=Number(h.amount||0);
    const buy=Number(h.buy_price||0);

    const id=idsMap[asset];
    const current=Number(prices?.[id]?.usd || 0);

    const invested=amount*buy;
    const value=amount*current;
    const pnl=value-invested;
    const roi = invested>0 ? (pnl/invested)*100 : 0;

    totalValue += value;
    totalInvested += invested;

    const pnlClass = pnl>0 ? "tagProfit" : (pnl<0 ? "tagLoss" : "tagFlat");
    const pnlTextClass = pnl>0 ? "ok" : (pnl<0 ? "err" : "neutral");

    tbody.innerHTML += `
      <tr>
        <td><strong>${asset.toUpperCase()}</strong></td>
        <td>${amount}</td>
        <td>${money(buy)}</td>
        <td>${money(current)}</td>
        <td><strong>${money(invested)}</strong></td>
        <td><strong>${money(value)}</strong></td>
        <td><span class="tag ${pnlClass}">${pnl>=0?"+":""}${money(pnl)}</span></td>
        <td class="${pnlTextClass}"><strong>${roi>=0?"+":""}${pct(roi)}</strong></td>
        <td>${h.notes || "-"}</td>
      </tr>
    `;

    // aggregate chart data
    const existing = bars.find(b => b.asset === asset);
    if(existing){
      existing.invested += invested;
      existing.value += value;
    }else{
      bars.push({asset, invested, value});
    }
  });

  // Allocation pie (aggregate by asset value)
  const valueByAsset = {};
  bars.forEach(b=>{
    valueByAsset[b.asset] = (valueByAsset[b.asset]||0) + b.value;
  });
  Object.keys(valueByAsset).forEach(a=>{
    pieLabels.push(a.toUpperCase());
    pieValues.push(valueByAsset[a]);
  });

  document.getElementById("total").innerHTML = money(totalValue);
  document.getElementById("invested").innerHTML = money(totalInvested);

  const totalPnL = totalValue-totalInvested;
  const totalROI = totalInvested>0 ? (totalPnL/totalInvested)*100 : 0;

  const pnlElem=document.getElementById("pnl");
  pnlElem.innerHTML = (totalPnL>=0?"+":"") + money(totalPnL);
  pnlElem.className = totalPnL>0 ? "ok" : (totalPnL<0 ? "err" : "neutral");

  document.getElementById("roi").innerHTML = `ROI: <strong>${totalROI>=0?"+":""}${pct(totalROI)}</strong>`;
  document.getElementById("msg").innerHTML = "<span class='ok'>Portfolio loaded ✅</span>";

  // Draw charts
  drawPie(pieLabels, pieValues);
  drawBars(bars);
}

/* ---------------- PIE CHART ---------------- */
function drawPie(labels, values){
  const canvas=document.getElementById("pieChart");
  const ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const total=values.reduce((a,b)=>a+b,0);
  if(total<=0){
    ctx.fillStyle="#94a3b8";
    ctx.font="16px system-ui";
    ctx.fillText("No data", 20, 40);
    document.getElementById("pieLegend").innerHTML="";
    return;
  }

  const colors=["#22c55e","#38bdf8","#facc15","#f87171","#a78bfa","#fb7185"];
  const cx=canvas.width/2;
  const cy=canvas.height/2;
  const r=Math.min(cx,cy)-10;

  let start=0;

  values.forEach((v,i)=>{
    const slice=(v/total)*Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.fillStyle=colors[i%colors.length];
    ctx.arc(cx,cy,r,start,start+slice);
    ctx.closePath();
    ctx.fill();
    start+=slice;
  });

  // center hole (donut style)
  ctx.beginPath();
  ctx.fillStyle="#020617";
  ctx.arc(cx,cy,r*0.55,0,Math.PI*2);
  ctx.fill();

  // total label
  ctx.fillStyle="#e5e7eb";
  ctx.font="bold 14px system-ui";
  ctx.textAlign="center";
  ctx.fillText("Allocation", cx, cy-6);
  ctx.font="bold 16px system-ui";
  ctx.fillText("100%", cx, cy+16);

  // legend
  const legend=document.getElementById("pieLegend");
  legend.innerHTML="";
  labels.forEach((lab,i)=>{
    const pct = ((values[i]/total)*100).toFixed(2);
    legend.innerHTML += `
      <div class="legendItem">
        <span class="dot" style="background:${colors[i%colors.length]}"></span>
        <strong>${lab}</strong> — ${pct}% (${money(values[i])})
      </div>
    `;
  });
}

/* ---------------- BAR CHART ---------------- */
function drawBars(bars){
  const canvas=document.getElementById("barChart");
  const ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!bars || bars.length===0){
    ctx.fillStyle="#94a3b8";
    ctx.font="16px system-ui";
    ctx.fillText("No data", 20, 40);
    return;
  }

  // setup
  const padding=30;
  const chartW=canvas.width - padding*2;
  const chartH=canvas.height - padding*2;

  const maxVal = Math.max(...bars.map(b=>Math.max(b.invested,b.value))) || 1;

  // title guide
  ctx.fillStyle="#94a3b8";
  ctx.font="12px system-ui";
  ctx.textAlign="left";
  ctx.fillText("Invested", padding, 16);
  ctx.fillStyle="#38bdf8";
  ctx.fillText("Current", padding+70, 16);

  const groupW = chartW / bars.length;
  const barW = Math.max(10, groupW*0.25);

  bars.forEach((b,i)=>{
    const x0 = padding + i*groupW + groupW/2;

    // invested bar
    const invH = (b.invested/maxVal)*chartH;
    ctx.fillStyle="#94a3b8";
    ctx.fillRect(x0 - barW - 4, padding + (chartH - invH), barW, invH);

    // value bar
    const valH = (b.value/maxVal)*chartH;
    ctx.fillStyle="#38bdf8";
    ctx.fillRect(x0 + 4, padding + (chartH - valH), barW, valH);

    // label
    ctx.fillStyle="#e5e7eb";
    ctx.font="12px system-ui";
    ctx.textAlign="center";
    ctx.fillText(b.asset.toUpperCase(), x0, canvas.height - 8);
  });

  // border
  ctx.strokeStyle="#1e293b";
  ctx.strokeRect(padding, padding, chartW, chartH);
}
</script>

</body>
</html>
