<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Secure Authentication | Coinluxora</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050a18;
      --stroke:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.65);
      --danger:#ef4444;
      --ok:#22c55e;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1200px 800px at 50% 20%, rgba(139,211,255,.10), transparent 55%) , var(--bg);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      padding:24px;
    }

    .card{
      width:min(520px, 100%);
      background:rgba(11,18,38,.86);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:22px 22px 18px;
      box-shadow:0 16px 50px rgba(0,0,0,.45);
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }

    .card:before{
      content:"";
      position:absolute;
      inset:-120px -160px auto -160px;
      height:260px;
      background:radial-gradient(circle at 50% 40%, rgba(139,211,255,.18), transparent 60%);
      pointer-events:none;
      z-index:0;
    }

    .layer{ position:relative; z-index:2; }

    .top{
      display:flex;
      align-items:center;
      gap:14px;
    }

    .avatar{
      width:54px;
      height:54px;
      border-radius:50%;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
      flex:0 0 auto;
    }

    .avatar img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
    }

    .avatar svg{ width:34px; height:34px; opacity:.9; }

    .who{ display:flex; flex-direction:column; gap:2px; }
    .name{ font-weight:700; letter-spacing:.2px; }
    .email{ font-size:.92rem; color:var(--muted); }

    .divider{
      height:1px;
      background:var(--stroke);
      margin:18px 0 16px;
    }

    h1{
      margin:0;
      font-size:1.75rem;
      letter-spacing:.2px;
    }
    .sub{
      margin:8px 0 0;
      color:var(--muted);
      font-size:1.02rem;
    }

    .pinDotsWrap{
      display:flex;
      justify-content:center;
      margin:22px 0 20px;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }

    .pinDots{
      display:flex;
      gap:18px;
      padding:6px 10px;
      border-radius:999px;
      transition:.14s ease;
    }

    .dot{
      width:16px;
      height:16px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.20);
      transition:.12s ease;
    }
    .dot.filled{
      background:rgba(255,255,255,.92);
      border-color:rgba(255,255,255,.92);
      transform:scale(1.08);
    }

    .attempts{
      font-size:12px;
      font-weight:900;
      letter-spacing:.2px;
      color:rgba(234,240,255,.65);
      min-height:16px;
      text-align:center;
      user-select:none;
    }
    .attempts.danger{
      color:rgba(248,113,113,.95);
    }

    @keyframes shake{
      0%{ transform:translateX(0); }
      15%{ transform:translateX(-10px); }
      30%{ transform:translateX(10px); }
      45%{ transform:translateX(-8px); }
      60%{ transform:translateX(8px); }
      75%{ transform:translateX(-6px); }
      90%{ transform:translateX(6px); }
      100%{ transform:translateX(0); }
    }
    .pinDots.shake{
      animation:shake .42s ease;
      background:rgba(239,68,68,.10);
      box-shadow:0 0 0 4px rgba(239,68,68,.14);
    }

    .lockTimer{
      width:100%;
      max-width:360px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      box-shadow:0 18px 55px rgba(0,0,0,.35);
      text-align:center;
      display:none;
    }
    .lockTimer.show{ display:block; }
    .lockTimer .t1{
      font-weight:1000;
      color:rgba(234,240,255,.90);
      letter-spacing:.2px;
    }
    .lockTimer .t2{
      margin-top:6px;
      font-size:22px;
      font-weight:1000;
      letter-spacing:1px;
      color:#fff;
    }
    .lockTimer .t3{
      margin-top:5px;
      font-size:12px;
      font-weight:900;
      color:rgba(234,240,255,.60);
    }

    .pad{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:14px;
      max-width:320px;
      margin:0 auto 18px;
      position:relative;
      z-index:5;
      transition:.2s ease;
    }

    .key{
      height:64px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.90);
      color:#0a0f1f;
      font-weight:800;
      font-size:1.25rem;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      transition:.12s ease;
    }
    .key:active{ transform:scale(.98); }

    .key.ghost{
      background:transparent;
      color:rgba(255,255,255,.75);
    }

    .pad.locked{
      opacity:.40;
      pointer-events:none;
      filter:grayscale(25%);
    }

    .smallActions{
      display:flex;
      justify-content:center;
      gap:12px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .linkBtn{
      background:transparent;
      border:none;
      color:rgba(139,211,255,.90);
      cursor:pointer;
      font-weight:700;
      font-size:.95rem;
    }
    .linkBtn:hover{ text-decoration:underline; }

    /* âœ… Popup overlay */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:18px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(420px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,18,38,.92);
      box-shadow:0 28px 90px rgba(0,0,0,.60);
      padding:20px 18px 18px;
      position:relative;
      overflow:hidden;
    }

    .modal:before{
      content:"";
      position:absolute;
      inset:-120px -140px auto -140px;
      height:240px;
      background:radial-gradient(circle at 50% 45%, rgba(255,255,255,.12), transparent 60%);
      pointer-events:none;
    }

    .modalInner{
      position:relative;
      z-index:2;
      text-align:center;
    }

    .statusCircle{
      width:66px;
      height:66px;
      border-radius:999px;
      margin:6px auto 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 16px 55px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
    }
    .statusCircle.ok{
      border-color:rgba(34,197,94,.35);
      background:rgba(34,197,94,.18);
      box-shadow:0 16px 55px rgba(34,197,94,.18);
    }
    .statusCircle.err{
      border-color:rgba(239,68,68,.40);
      background:rgba(239,68,68,.16);
      box-shadow:0 16px 55px rgba(239,68,68,.16);
    }
    .statusCircle.info{
      border-color:rgba(139,211,255,.35);
      background:rgba(139,211,255,.14);
      box-shadow:0 16px 55px rgba(139,211,255,.12);
    }
    .statusCircle svg{ width:34px; height:34px; }

    .modalTitle{
      font-weight:900;
      font-size:1.5rem;
      letter-spacing:.2px;
      margin:0;
    }
    .modalSub{
      margin:10px 0 0;
      color:rgba(234,240,255,.72);
      font-size:1.02rem;
      line-height:1.45;
      white-space:pre-line;
    }

    /* âœ… modal buttons */
    .modalBtns{
      display:flex;
      gap:10px;
      margin-top:16px;
    }
    .mBtn{
      flex:1;
      height:48px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .mBtn.cancel{
      background:rgba(255,255,255,.06);
      color:rgba(234,240,255,.85);
    }
    .mBtn.danger{
      background:linear-gradient(180deg, rgba(248,113,113,1), rgba(239,68,68,1));
      color:#040814;
      border:none;
      box-shadow:0 18px 55px rgba(239,68,68,.18);
    }
    .mBtn.primary{
      background:linear-gradient(180deg, rgba(139,211,255,1), rgba(59,130,246,1));
      color:#040814;
      border:none;
      box-shadow:0 18px 55px rgba(59,130,246,.14);
    }

    /* âœ… email input inside modal */
    .emailBox{
      margin-top:14px;
      display:none;
      text-align:left;
    }
    .emailBox.show{ display:block; }
    .emailBox label{
      display:block;
      font-size:12px;
      font-weight:900;
      letter-spacing:.2px;
      color:rgba(234,240,255,.75);
      margin:0 0 8px;
    }
    .emailBox input{
      width:100%;
      height:48px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:#fff;
      padding:0 14px;
      outline:none;
      font-weight:800;
    }
    .emailBox input::placeholder{ color:rgba(234,240,255,.45); }
  </style>
</head>

<body>

  <div class="card">
    <div class="layer">

      <div class="top">
        <div class="avatar">
          <img id="avatarImg" alt="Profile"/>
          <svg id="avatarIcon" viewBox="0 0 24 24" fill="none">
            <path d="M12 12c2.76 0 5-2.24 5-5S14.76 2 12 2 7 4.24 7 7s2.24 5 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z" fill="currentColor" opacity=".85"/>
          </svg>
        </div>

        <div class="who">
          <div class="name" id="userName">Loading...</div>
          <div class="email" id="userEmail"></div>
        </div>
      </div>

      <div class="divider"></div>

      <h1>Secure Authentication</h1>
      <div class="sub" id="subText">Please verify your 4-digit PIN code</div>

      <div class="pinDotsWrap">
        <div class="pinDots" id="pinDots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>

        <div class="attempts" id="attemptsText"></div>

        <div class="lockTimer" id="lockTimer">
          <div class="t1">Too many incorrect attempts ðŸ”’</div>
          <div class="t2" id="lockTimeText">05:00</div>
          <div class="t3">Try again when the timer ends.</div>
        </div>
      </div>

      <div class="pad" id="pad">
        <button type="button" class="key" data-num="7">7</button>
        <button type="button" class="key" data-num="0">0</button>
        <button type="button" class="key" data-num="1">1</button>

        <button type="button" class="key" data-num="2">2</button>
        <button type="button" class="key" data-num="3">3</button>
        <button type="button" class="key" data-num="8">8</button>

        <button type="button" class="key" data-num="4">4</button>
        <button type="button" class="key" data-num="5">5</button>
        <button type="button" class="key" data-num="6">6</button>

        <button type="button" class="key" data-num="9">9</button>
        <button type="button" class="key ghost" data-action="backspace">âŒ«</button>
        <button type="button" class="key ghost" data-action="clear">Clear</button>
      </div>

      <div class="smallActions">
        <button type="button" class="linkBtn" id="forgotPinBtn">Forgot PIN?</button>
        <button type="button" class="linkBtn" id="logoutBtn">Log out</button>
      </div>

    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalInner">
        <div class="statusCircle" id="statusCircle"></div>
        <h2 class="modalTitle" id="modalTitle"></h2>
        <div class="modalSub" id="modalSub"></div>

        <!-- âœ… Email input -->
        <div class="emailBox" id="emailBox">
          <label for="forgotEmailInput">Email address</label>
          <input id="forgotEmailInput" type="email" placeholder="Enter your email (e.g. you@gmail.com)" autocomplete="email"/>
        </div>

        <div class="modalBtns" id="modalBtns" style="display:none;">
          <button class="mBtn cancel" type="button" id="modalCancelBtn">Cancel</button>
          <button class="mBtn primary" type="button" id="modalSendBtn">Send PIN</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const pad = document.getElementById("pad");
  const subText = document.getElementById("subText");
  const userName = document.getElementById("userName");
  const userEmail = document.getElementById("userEmail");
  const logoutBtn = document.getElementById("logoutBtn");

  const forgotPinBtn = document.getElementById("forgotPinBtn");

  const pinDotsEl = document.getElementById("pinDots");
  const dots = Array.from(document.querySelectorAll(".dot"));

  const avatarImg = document.getElementById("avatarImg");
  const avatarIcon = document.getElementById("avatarIcon");

  const overlay = document.getElementById("overlay");
  const statusCircle = document.getElementById("statusCircle");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");
  const modalBtns = document.getElementById("modalBtns");
  const modalCancelBtn = document.getElementById("modalCancelBtn");
  const modalSendBtn = document.getElementById("modalSendBtn");

  const emailBox = document.getElementById("emailBox");
  const forgotEmailInput = document.getElementById("forgotEmailInput");

  const lockTimer = document.getElementById("lockTimer");
  const lockTimeText = document.getElementById("lockTimeText");

  const attemptsText = document.getElementById("attemptsText");

  let input = "";
  let mode = "verify";
  let pinHashFromDb = null;
  let user = null;
  let supabaseClient = null;
  let isBusy = false;

  const MAX_TRIES = 5;
  const LOCK_MINUTES = 5;
  let lockInterval = null;
  let limiterId = "guest";

  function triesKey(){ return `coinluxora_pin_tries_${limiterId}`; }
  function lockKey(){  return `coinluxora_pin_lock_${limiterId}`; }

  function getTries(){
    const t = parseInt(localStorage.getItem(triesKey()) || "0", 10);
    return isNaN(t) ? 0 : t;
  }
  function setTries(val){
    localStorage.setItem(triesKey(), String(val));
  }

  function getLockUntil(){
    const v = parseInt(localStorage.getItem(lockKey()) || "0", 10);
    return isNaN(v) ? 0 : v;
  }
  function setLockUntil(ts){
    localStorage.setItem(lockKey(), String(ts));
  }

  function formatMMSS(ms){
    const totalSec = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(totalSec/60);
    const s = totalSec % 60;
    return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
  }

  function lockKeypad(){
    pad.classList.add("locked");
    lockTimer.classList.add("show");
    attemptsText.textContent = "";
    attemptsText.classList.remove("danger");
  }
  function unlockKeypad(){
    pad.classList.remove("locked");
    lockTimer.classList.remove("show");
  }

  function updateAttemptsUI(){
    const tries = getTries();
    const left = Math.max(0, MAX_TRIES - tries);

    const until = getLockUntil();
    const locked = (until && until > Date.now());

    if(mode !== "verify" || locked){
      attemptsText.textContent = "";
      attemptsText.classList.remove("danger");
      return;
    }

    if(tries <= 0){
      attemptsText.textContent = "";
      attemptsText.classList.remove("danger");
      return;
    }

    attemptsText.textContent = `Attempts left: ${left}`;
    attemptsText.classList.toggle("danger", left <= 2);
  }

  function startCountdown(){
    clearInterval(lockInterval);

    lockKeypad();

    const tick = ()=>{
      const until = getLockUntil();
      const remaining = until - Date.now();

      if(remaining <= 0){
        clearInterval(lockInterval);
        lockInterval = null;
        setLockUntil(0);
        setTries(0);
        unlockKeypad();
        resetInput();
        isBusy = false;
        updateAttemptsUI();
        return;
      }

      lockTimeText.textContent = formatMMSS(remaining);
    };

    tick();
    lockInterval = setInterval(tick, 250);
  }

  function enforceLockIfNeeded(){
    const until = getLockUntil();
    if(until && until > Date.now()){
      startCountdown();
      return true;
    }
    return false;
  }

  function lockFor5Minutes(){
    const until = Date.now() + LOCK_MINUTES * 60 * 1000;
    setLockUntil(until);
    startCountdown();
  }

  function renderDots(){
    dots.forEach((d, i)=> d.classList.toggle("filled", i < input.length));
  }

  function resetInput(){
    input = "";
    renderDots();
  }

  function shakeDots(){
    pinDotsEl.classList.remove("shake");
    void pinDotsEl.offsetWidth;
    pinDotsEl.classList.add("shake");
    setTimeout(()=> pinDotsEl.classList.remove("shake"), 520);
  }

  function softVibrate(){
    try{
      if(navigator.vibrate){
        navigator.vibrate([18, 30, 18]);
      }
    }catch(e){}
  }

  function addDigit(n){
    if(isBusy) return;
    if(enforceLockIfNeeded()) return;
    if(input.length >= 4) return;

    input += String(n);
    renderDots();

    if(input.length === 4){
      setTimeout(()=> verifyPin(), 120);
    }
  }

  pad.addEventListener("click", (e)=>{
    if(enforceLockIfNeeded()) return;

    const btn = e.target.closest("button");
    if(!btn) return;

    const num = btn.getAttribute("data-num");
    const action = btn.getAttribute("data-action");

    if(num !== null){
      addDigit(num);
      return;
    }

    if(action === "backspace"){
      if(isBusy) return;
      input = input.slice(0, -1);
      renderDots();
      return;
    }

    if(action === "clear"){
      if(isBusy) return;
      resetInput();
      return;
    }
  });

  function showPopup(type, title, sub){
    modalBtns.style.display = "none";
    emailBox.classList.remove("show");
    forgotEmailInput.value = "";

    statusCircle.className = "statusCircle " + type;
    modalTitle.textContent = title;
    modalSub.textContent = sub;

    if(type === "ok"){
      statusCircle.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M20 6 9 17l-5-5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
    } else if(type === "err"){
      statusCircle.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6 6 18" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
        </svg>`;
    } else {
      statusCircle.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 22c5.52 0 10-4.48 10-10S17.52 2 12 2 2 6.48 2 12s4.48 10 10 10Z" stroke="white" stroke-width="2.2"/>
          <path d="M12 8v5" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
          <path d="M12 16h.01" stroke="white" stroke-width="4" stroke-linecap="round"/>
        </svg>`;
    }

    overlay.classList.add("show");
  }

  function hidePopup(){
    overlay.classList.remove("show");
  }

  const SUPABASE_URL = "https://xdcscknfomlzwysczegc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";

  async function sha256(str){
    const data = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
  }

  /* =========================================================
     âœ… Personal-use reversible pin store (simple obfuscation)
     - This is NOT strong encryption; only for learning/personal
     ========================================================= */
  function encodePin(pin, userId){
    // simple reversible obfuscation using base64 and userId salt
    try{
      const raw = `${pin}::${userId}`;
      return btoa(unescape(encodeURIComponent(raw)));
    }catch(e){
      return "";
    }
  }
  function decodePin(encoded, userId){
    try{
      const raw = decodeURIComponent(escape(atob(encoded)));
      const parts = raw.split("::");
      if(parts.length !== 2) return null;
      if(parts[1] !== userId) return null;
      return parts[0];
    }catch(e){
      return null;
    }
  }

  function applyAvatarPhoto(u){
    const meta = u?.user_metadata || {};
    const photo = meta.avatar_url || meta.picture || meta.photoURL || meta.profile_photo || "";
    if(photo){
      avatarImg.src = photo;
      avatarImg.style.display = "block";
      avatarIcon.style.display = "none";
      avatarImg.onerror = () => {
        avatarImg.style.display = "none";
        avatarIcon.style.display = "block";
      };
    }
  }

  async function init(){
    try{
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      await new Promise(r => setTimeout(r, 150));
      const { data: sessData } = await supabaseClient.auth.getSession();
      const session = sessData?.session;

      if(!session?.user){
        window.location.href = "/login.html";
        return;
      }

      user = session.user;

      limiterId = (user.email || user.id || "guest").toLowerCase().replace(/[^a-z0-9@._-]/g,"_");

      userEmail.textContent = user.email || "";
      userName.textContent = (user.user_metadata?.full_name || user.user_metadata?.name || "User");
      applyAvatarPhoto(user);

      enforceLockIfNeeded();

      const { data, error } = await supabaseClient
        .from("user_pins")
        .select("pin_hash, pin_hint")
        .eq("user_id", user.id)
        .maybeSingle();

      if(error){
        console.error(error);
        return;
      }

      if(!data){
        mode = "create";
        pinHashFromDb = null;
        subText.textContent = "Create your new 4-digit PIN";
      } else {
        mode = "verify";
        pinHashFromDb = data.pin_hash;
        subText.textContent = "Please verify your 4-digit PIN code";
      }

      resetInput();
      updateAttemptsUI();
    }catch(err){
      console.error(err);
    }
  }

  async function verifyPin(){
    if(isBusy) return;
    if(enforceLockIfNeeded()) return;
    if(input.length !== 4) return;
    if(!supabaseClient || !user) return;

    isBusy = true;

    try{
      if(mode === "create"){
        const newHash = await sha256(input + ":" + user.id);
        const hint = encodePin(input, user.id);

        const { error } = await supabaseClient
          .from("user_pins")
          .insert([{ user_id: user.id, pin_hash: newHash, pin_hint: hint }]);

        if(error){
          console.error(error);
          isBusy = false;
          resetInput();
          return;
        }

        setTries(0);
        setLockUntil(0);
        unlockKeypad();

        showPopup("ok", "PIN Created âœ”ï¸", "Redirecting you to your dashboard...");
        setTimeout(()=> window.location.href = "/user-dashboard.html", 650);

      } else {
        const attemptHash = await sha256(input + ":" + user.id);

        if(attemptHash !== pinHashFromDb){
          softVibrate();

          let tries = getTries() + 1;
          setTries(tries);

          shakeDots();
          updateAttemptsUI();

          if(tries >= MAX_TRIES){
            resetInput();
            showPopup("err", "Too Many Attempts ðŸ”’", "Please wait 5 minutes and try again.");
            lockFor5Minutes();

            setTimeout(()=>{
              hidePopup();
              isBusy = false;
            }, 950);
            return;
          }

          showPopup("err", "Incorrect PIN âŒ", `${MAX_TRIES - tries} tries left. Please try again.`);

          setTimeout(()=>{
            hidePopup();
            isBusy = false;
            resetInput();
          }, 950);
          return;
        }

        setTries(0);
        setLockUntil(0);
        unlockKeypad();
        updateAttemptsUI();

        showPopup("ok", "Verified âœ”ï¸", "Redirecting you to your dashboard...");
        setTimeout(()=> window.location.href = "/user-dashboard.html", 520);
      }
    }catch(err){
      console.error(err);
      isBusy = false;
      resetInput();
    }
  }

  /* =========================================================
     âœ… Forgot PIN -> ask email -> send PIN to that email
     Uses Supabase Edge Function: send-pin
     ========================================================= */
  forgotPinBtn.addEventListener("click", ()=>{
    if(isBusy) return;

    showPopup(
      "info",
      "Forgot PIN?",
      "Enter your email address.\nIf it matches your account, we will send your PIN to your email."
    );

    emailBox.classList.add("show");
    modalBtns.style.display = "flex";

    // auto-fill user email
    forgotEmailInput.value = (user?.email || "");
    setTimeout(()=> { try{ forgotEmailInput.focus(); }catch(e){} }, 60);
  });

  modalCancelBtn.addEventListener("click", ()=>{
    hidePopup();
  });

  modalSendBtn.addEventListener("click", async ()=>{
    if(isBusy) return;
    if(!supabaseClient || !user) return;

    const enteredEmail = (forgotEmailInput.value || "").trim().toLowerCase();
    const realEmail = (user.email || "").trim().toLowerCase();

    if(!enteredEmail || !enteredEmail.includes("@")){
      showPopup("err", "Invalid Email", "Please enter a valid email address.");
      setTimeout(()=>{
        // reopen input modal
        showPopup("info","Forgot PIN?","Enter your email address.\nIf it matches your account, we will send your PIN to your email.");
        emailBox.classList.add("show");
        modalBtns.style.display = "flex";
        forgotEmailInput.value = realEmail;
        try{ forgotEmailInput.focus(); }catch(e){}
      }, 900);
      return;
    }

    // must match logged in user email
    if(enteredEmail !== realEmail){
      showPopup("err", "Email Mismatch", "That email does not match your logged-in account.");
      return;
    }

    isBusy = true;

    try{
      // pull hint
      const { data, error } = await supabaseClient
        .from("user_pins")
        .select("pin_hint")
        .eq("user_id", user.id)
        .maybeSingle();

      if(error){
        console.error(error);
        showPopup("err", "Error", "Could not retrieve your PIN. Try again.");
        isBusy = false;
        return;
      }

      const hint = data?.pin_hint || "";
      const pin = decodePin(hint, user.id);

      if(!pin){
        showPopup("err", "PIN Not Recoverable", "Your PIN cannot be recovered. Please log out and create a new one.");
        isBusy = false;
        return;
      }

      showPopup("info", "Sendingâ€¦", "Please wait while we send your PIN to your email.");

      // Call edge function
      const { data: fnData, error: fnError } = await supabaseClient.functions.invoke("send-pin", {
        body: { email: enteredEmail, pin }
      });

      if(fnError){
        console.error(fnError);
        showPopup("err", "Email Failed", "Could not send email. Please try again.");
        isBusy = false;
        return;
      }

      showPopup("ok", "Sent âœ”ï¸", "Your PIN has been sent to your email.");
      setTimeout(()=>{
        hidePopup();
        isBusy = false;
      }, 1100);

    }catch(err){
      console.error(err);
      showPopup("err", "Error", "Something went wrong. Try again.");
      isBusy = false;
    }
  });

  logoutBtn.addEventListener("click", async ()=>{
    try{
      if(supabaseClient) await supabaseClient.auth.signOut();
    }catch(e){}
    window.location.href = "/login.html";
  });

  init();
</script>

</body>
</html>
