<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Withdraw - Coinluxora</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ---------- Base ---------- */
body{margin:0;font-family:Arial,sans-serif;background:#0b0f19;color:#fff}
.layout{display:flex;min-height:100vh}
.sidebar{width:240px;background:#0f172a;padding:18px;border-right:1px solid rgba(255,255,255,.08)}
.brand{font-size:20px;font-weight:800;margin-bottom:22px}
.nav a{display:block;padding:12px;margin:6px 0;border-radius:10px;color:#fff;text-decoration:none;background:rgba(255,255,255,.05);font-weight:700}
.nav a.active{background:rgba(99,102,241,.25)}
.main{flex:1;padding:20px}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:16px;border-radius:16px;background:rgba(255,255,255,.05);margin-bottom:18px}

.card{max-width:1000px;margin:0 auto 18px;padding:20px;border-radius:18px;background:rgba(255,255,255,.05)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.full{grid-column:1/-1}

input,select{width:100%;padding:13px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#000;color:#fff}
button{padding:12px;border-radius:12px;border:0;font-weight:900;cursor:pointer}
.primary{width:100%;background:linear-gradient(90deg,#6366f1,#22c55e);color:#fff}
.miniBtn{padding:8px 10px;font-size:12px;border-radius:8px;background:rgba(255,255,255,.1);color:#fff}
.dangerBtn{padding:8px 10px;font-size:12px;border-radius:8px;background:rgba(244,63,94,.2);color:#fb7185;border:1px solid rgba(244,63,94,.4)}

.msg{margin-top:12px;padding:10px;border-radius:10px;display:none}
.msg.ok{display:block;color:#4ade80}
.msg.err{display:block;color:#fb7185}

/* ---------- Table ---------- */
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1);font-size:13px}
th{opacity:.8}
.pill{padding:5px 9px;border-radius:999px;font-weight:900;font-size:11px}
.pending{color:#fde047;background:rgba(250,204,21,.15)}
.approved{color:#4ade80;background:rgba(34,197,94,.15)}
.rejected{color:#fb7185;background:rgba(244,63,94,.15)}
.cancelled{color:#cbd5e1;background:rgba(148,163,184,.15)}

/* ---------- Tabs ---------- */
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:7px 12px;border-radius:999px;background:rgba(255,255,255,.08);cursor:pointer;font-weight:800;font-size:12px}
.tab.active{background:rgba(99,102,241,.35)}

/* ---------- Modal ---------- */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.65);
  display:none;align-items:center;justify-content:center;z-index:999
}
.modalBox{
  width:95%;max-width:520px;
  background:#0f172a;border-radius:18px;padding:20px;
  box-shadow:0 20px 60px rgba(0,0,0,.6)
}
.modalBox h3{margin-top:0}
.modalRow{margin-bottom:10px;font-size:14px}
.modalRow span{opacity:.7}
.closeBtn{margin-top:10px;width:100%;background:#1f2937;color:#fff}

/* ---------- Responsive ---------- */
@media(max-width:900px){
  .sidebar{display:none}
  .grid{grid-template-columns:1fr}
}
</style>
</head>

<body>
<div class="layout">

<aside class="sidebar">
  <div class="brand">COINLUXORA</div>
  <div class="nav">
    <a href="user_dashboard.html">Dashboard</a>
    <a href="deposit.html">Deposit</a>
    <a class="active" href="withdraw.html">Withdraw</a>
    <a href="account.html">Account</a>
  </div>
</aside>

<main class="main">
<div class="topbar">
  <h2>Withdrawals</h2>
  <div id="userEmail"></div>
</div>

<!-- Withdraw form -->
<div class="card">
<h3>Request Withdrawal</h3>
<div class="grid">
  <div>
    <label>Amount</label>
    <input id="amount" type="number">
  </div>
  <div>
    <label>Asset</label>
    <select id="asset">
      <option>USD</option><option>ETH</option><option>BTC</option><option>USDT</option>
    </select>
  </div>
  <div class="full">
    <label>Network</label>
    <select id="network">
      <option>TRC20</option><option>ERC20</option><option>BEP20</option>
    </select>
  </div>
  <div class="full">
    <label>Wallet Address</label>
    <input id="wallet_address">
  </div>
  <div class="full">
    <button class="primary" id="submitBtn">Submit Withdrawal</button>
    <div id="msg" class="msg"></div>
  </div>
</div>
</div>

<!-- History -->
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
  <h3>Withdrawal History</h3>
  <div class="tabs" id="tabs">
    <div class="tab active" data-status="all">All</div>
    <div class="tab" data-status="pending">Pending</div>
    <div class="tab" data-status="approved">Approved</div>
    <div class="tab" data-status="rejected">Rejected</div>
    <div class="tab" data-status="cancelled">Cancelled</div>
  </div>
</div>

<div id="history"></div>
<button id="loadMore" class="miniBtn" style="display:none;margin-top:10px">Load more</button>
</div>
</main>
</div>

<!-- ---------- VIEW DETAILS MODAL ---------- -->
<div class="modal" id="detailsModal">
  <div class="modalBox">
    <h3>Withdrawal Details</h3>
    <div id="detailsBody"></div>
    <button class="closeBtn" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const historyEl=document.getElementById("history");
const loadMoreBtn=document.getElementById("loadMore");
const modal=document.getElementById("detailsModal");
const detailsBody=document.getElementById("detailsBody");

let email=null,filter="all",limit=10,offset=0,cache=[];

function pill(s){
  s=s||"pending";
  return `<span class="pill ${s}">${s.toUpperCase()}</span>`;
}

function openModal(w){
  detailsBody.innerHTML=`
    <div class="modalRow"><span>ID:</span> ${w.id}</div>
    <div class="modalRow"><span>Amount:</span> ${w.amount}</div>
    <div class="modalRow"><span>Asset:</span> ${w.asset}</div>
    <div class="modalRow"><span>Network:</span> ${w.network}</div>
    <div class="modalRow"><span>Wallet:</span> ${w.wallet_address}</div>
    <div class="modalRow"><span>Status:</span> ${pill(w.status)}</div>
    <div class="modalRow"><span>Method:</span> ${w.method}</div>
    <div class="modalRow"><span>Date:</span> ${new Date(w.created_at).toLocaleString()}</div>
  `;
  modal.style.display="flex";
}
function closeModal(){ modal.style.display="none"; }

function render(){
  if(cache.length===0){historyEl.innerHTML="No withdrawals";return;}
  historyEl.innerHTML=`
  <table>
  <tr><th>Asset</th><th>Amount</th><th>Status</th><th>Action</th></tr>
  ${cache.map(w=>`
    <tr>
      <td>${w.asset}</td>
      <td>${w.amount}</td>
      <td>${pill(w.status)}</td>
      <td>
        <button class="miniBtn" onclick='openModal(${JSON.stringify(w)})'>View</button>
        ${w.status==="pending"
          ? `<button class="dangerBtn" onclick="cancel('${w.id}')">Cancel</button>`
          : ""}
      </td>
    </tr>
  `).join("")}
  </table>`;
}

async function load(reset=false){
  if(reset){offset=0;cache=[]}
  let q=supabase.from("withdrawals").select("*").eq("user_email",email)
    .order("created_at",{ascending:false})
    .range(offset,offset+limit-1);
  if(filter!=="all")q=q.eq("status",filter);
  const {data}=await q;
  if(data){cache=cache.concat(data);render()}
  loadMoreBtn.style.display=data&&data.length===limit?"block":"none";
  offset+=limit;
}

async function cancel(id){
  if(!confirm("Cancel withdrawal?"))return;
  await supabase.from("withdrawals")
    .update({status:"cancelled"})
    .eq("id",id)
    .eq("user_email",email);
  load(true);
}

document.getElementById("tabs").onclick=e=>{
  if(!e.target.dataset.status)return;
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  e.target.classList.add("active");
  filter=e.target.dataset.status;
  load(true);
};

loadMoreBtn.onclick=()=>load();

(async()=>{
  const u=await supabase.auth.getUser();
  email=u.data.user.email;
  document.getElementById("userEmail").textContent=email;
  load(true);
})();
</script>
</body>
</html>
