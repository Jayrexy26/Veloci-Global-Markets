<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Withdraw - Coinluxora</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .box { max-width: 480px; margin: auto; border: 1px solid #333; padding: 20px; border-radius: 10px; }
    input, select, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #666; }
    button { cursor: pointer; font-weight: bold; }
    #msg { margin-top: 15px; font-weight: bold; }
  </style>
</head>

<body>
  <div class="box">
    <h2>Request Withdrawal</h2>

    <label>Amount</label>
    <input type="number" id="amount" placeholder="Enter amount" />

    <label>Asset</label>
    <select id="asset">
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="GBP">GBP</option>
      <option value="NGN">ETH</option>
      <option value="BTC">BTC</option>
      <option value="USDT">USDT</option>
    </select>

    <label>Network</label>
    <input type="text" id="network" placeholder="e.g. TRC20 / ERC20 / BTC" />

    <label>Wallet Address</label>
    <input type="text" id="wallet_address" placeholder="Enter your wallet address" />

    <button id="submitBtn">Submit Withdrawal</button>

    <div id="msg"></div>
  </div>

<script>
  // ✅ Supabase init
  const SUPABASE_URL = "https://xdcscknfomlzwysczegc.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE"; // <-- PUT YOUR ANON KEY
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const msg = document.getElementById("msg");

  function showMessage(text, ok=false){
    msg.innerText = text;
    msg.style.color = ok ? "limegreen" : "tomato";
  }

  document.getElementById("submitBtn").addEventListener("click", async () => {
    try {
      showMessage("Submitting withdrawal request...");

      // ✅ Session check
      const { data: sessionData } = await supabase.auth.getSession();
      const session = sessionData?.session;

      if (!session) {
        showMessage("You are not logged in. Please login first.");
        return;
      }

      const amount = Number(document.getElementById("amount").value);
      const asset = document.getElementById("asset").value; // ✅ asset
      const network = document.getElementById("network").value.trim();
      const wallet_address = document.getElementById("wallet_address").value.trim();

      if (!amount || amount <= 0) {
        showMessage("Enter a valid amount.");
        return;
      }

      if (!wallet_address) {
        showMessage("Wallet address is required.");
        return;
      }

      // ✅ must send asset to match DB column
      const payload = {
        amount,
        asset,
        network,
        wallet_address,
        method: "crypto"
      };

      const res = await fetch(`${SUPABASE_URL}/functions/v1/request_withdrawal`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${session.access_token}`
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (!res.ok || data?.error) {
        console.error("Withdraw error:", data);
        showMessage(data?.details || data?.error || "Withdrawal failed.");
        return;
      }

      showMessage("Withdrawal submitted successfully ✅", true);

      // Clear inputs
      document.getElementById("amount").value = "";
      document.getElementById("network").value = "";
      document.getElementById("wallet_address").value = "";

    } catch (err) {
      console.error(err);
      showMessage("Unexpected error occurred.");
    }
  });
</script>

</body>
</html>
