<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Coinluxora User Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#050a18;
  --stroke:rgba(255,255,255,.12);
  --text:#eaf0ff;
  --muted:rgba(234,240,255,.65);

  --ok:#22c55e;
  --err:#ef4444;
  --warn:#f59e0b;

  --card:rgba(255,255,255,.05);
  --glow:0 0 30px rgba(88,101,242,.22);
  --radius:18px;
}

*{box-sizing:border-box;}
html,body{height:100%;}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background: radial-gradient(1200px 700px at 20% -10%, rgba(88,101,242,.25), transparent 55%),
              radial-gradient(900px 600px at 85% 0%, rgba(34,197,94,.12), transparent 60%),
              var(--bg);
  color:var(--text);
}

a{color:inherit;text-decoration:none;}

.container{
  max-width:1100px;
  margin:0 auto;
  padding:16px;
}

.topbar{
  position:sticky;
  top:0;
  z-index:50;
  backdrop-filter: blur(18px);
  background:rgba(5,10,24,.55);
  border:1px solid var(--stroke);
  box-shadow:var(--glow);
  border-radius:22px;
  padding:12px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.brand{
  display:flex;align-items:center;gap:10px;
  font-weight:800;
  letter-spacing:.3px;
}
.logo{
  width:38px;height:38px;border-radius:12px;
  background:linear-gradient(135deg, rgba(88,101,242,.95), rgba(34,197,94,.75));
  box-shadow:0 10px 25px rgba(0,0,0,.35);
}

.status-pill{
  display:flex;align-items:center;gap:8px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.06);
  font-size:13px;
  color:var(--muted);
  white-space:nowrap;
}
.dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--ok);
  box-shadow:0 0 12px rgba(34,197,94,.8);
}

.grid{
  margin-top:16px;
  display:grid;
  grid-template-columns: 1.25fr .75fr;
  gap:14px;
}
@media(max-width:920px){
  .grid{grid-template-columns:1fr; }
}

.card{
  border:1px solid var(--stroke);
  background:var(--card);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:0 14px 35px rgba(0,0,0,.35);
  overflow:hidden;
  transition:.15s transform ease, .15s box-shadow ease, .15s border-color ease;
}
.card:active{
  transform:scale(.995);
  border-color:rgba(255,255,255,.2);
  box-shadow:0 18px 45px rgba(0,0,0,.5);
}
.card h3{
  margin:0 0 10px 0;
  font-size:15px;
  color:rgba(234,240,255,.85);
  letter-spacing:.2px;
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.pill{
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.06);
  padding:9px 10px;
  border-radius:999px;
  font-size:13px;
  color:var(--muted);
}

.market-header{
  display:flex;justify-content:space-between;align-items:center;gap:10px;
  margin-bottom:10px;
}
.select{
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:9px 10px;
  border-radius:12px;
  outline:none;
}

.orderbook{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.book-col{
  border:1px solid var(--stroke);
  border-radius:16px;
  overflow:hidden;
}
.book-head{
  display:flex;justify-content:space-between;
  padding:10px 10px;
  font-size:12px;
  color:rgba(234,240,255,.75);
  border-bottom:1px solid var(--stroke);
  background:rgba(255,255,255,.05);
}
.book-list{
  max-height:270px;
  overflow:auto;
}
.level{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap:6px;
  padding:8px 10px;
  font-size:12.5px;
  font-variant-numeric:tabular-nums;
}
.level:nth-child(odd){ background:rgba(255,255,255,.02); }

.price.bid{ color:rgba(34,197,94,.95); }
.price.ask{ color:rgba(239,68,68,.95); }

.small-muted{color:var(--muted);font-size:12px;}
.big{
  font-size:28px;
  font-weight:900;
  letter-spacing:.3px;
}
.sub{
  color:rgba(234,240,255,.7);
  font-size:13px;
}

.bottom-nav{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  width:min(520px, calc(100% - 26px));
  background:rgba(10,16,40,.65);
  border:1px solid var(--stroke);
  border-radius:24px;
  padding:10px 12px;
  display:flex;justify-content:space-between;align-items:center;
  backdrop-filter: blur(18px);
  z-index:99;
  box-shadow:0 18px 55px rgba(0,0,0,.55);
}
.navbtn{
  width:22%;
  text-align:center;
  padding:10px 8px;
  border-radius:18px;
  color:rgba(234,240,255,.75);
  font-size:12px;
  border:1px solid transparent;
}
.navbtn.active{
  background:rgba(88,101,242,.18);
  border-color:rgba(88,101,242,.35);
  color:rgba(234,240,255,.95);
}
.fab{
  width:56px;height:56px;border-radius:18px;
  background:linear-gradient(135deg, rgba(88,101,242,.95), rgba(34,197,94,.85));
  display:grid;place-items:center;
  margin-top:-30px;
  border:1px solid rgba(255,255,255,.18);
  box-shadow:0 22px 50px rgba(0,0,0,.6);
}

.scroll-btn{
  position:fixed;
  right:14px;
  width:44px;height:44px;border-radius:16px;
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.08);
  backdrop-filter: blur(14px);
  display:grid;place-items:center;
  box-shadow:0 18px 55px rgba(0,0,0,.55);
  z-index:98;
  cursor:pointer;
  user-select:none;
}
#scrollUp{ bottom:92px; }
#scrollDown{ bottom:40px; }
.scroll-btn:active{ transform:scale(.98); }

.footer-space{height:98px;}
</style>
</head>
<body>

<div class="container">

  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div style="font-size:15px;">Coinluxora</div>
        <div class="small-muted" id="countryIndicator">üåç Loading region...</div>
      </div>
    </div>

    <div class="row">
      <div class="status-pill"><span class="dot" id="connDot"></span><span id="connText">Connected</span></div>
      <div class="status-pill">üë§ <span id="userEmail">guest@coinluxora</span></div>
    </div>
  </div>

  <div class="grid">

    <div>
      <div class="card" id="liveMarketCard">
        <div class="market-header">
          <h3 style="margin:0;">Live Market</h3>
          <select class="select" id="symbolSelect">
            <option value="BTCUSDT">BTC/USDT</option>
            <option value="ETHUSDT">ETH/USDT</option>
            <option value="BNBUSDT">BNB/USDT</option>
            <option value="SOLUSDT">SOL/USDT</option>
            <option value="XRPUSDT">XRP/USDT</option>
          </select>
        </div>

        <div class="row" style="align-items:baseline;">
          <div class="big" id="livePrice">$0.00</div>
          <div class="pill" id="liveChange">0.00%</div>
        </div>
        <div class="small-muted" id="liveHint">Live pricing updates</div>
      </div>

      <div class="card" style="margin-top:14px;">
        <h3>Order Book</h3>

        <div class="orderbook">
          <div class="book-col">
            <div class="book-head">
              <span>Bid</span><span>Size</span><span>Total</span>
            </div>
            <div class="book-list" id="bids"></div>
          </div>

          <div class="book-col">
            <div class="book-head">
              <span>Ask</span><span>Size</span><span>Total</span>
            </div>
            <div class="book-list" id="asks"></div>
          </div>
        </div>

        <div class="small-muted" id="orderBookStatus" style="margin-top:10px;">
          Loading order book...
        </div>
      </div>

    </div>

    <div>
      <div class="card">
        <h3>Portfolio Value</h3>
        <div class="big" id="portfolioValue">$0.00</div>
        <div class="sub">Your estimated balance</div>
      </div>

      <div class="card" style="margin-top:14px;">
        <h3>Profile</h3>
        <div class="row">
          <div class="pill">Plan: <b id="planName">Free</b></div>
          <div class="pill">Status: <b id="planStatus">Active</b></div>
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <h3>Mini Chart</h3>
        <div class="small-muted">Chart stays same (no changes)</div>
        <div style="height:140px;border:1px dashed rgba(255,255,255,.18);border-radius:16px;margin-top:10px;display:grid;place-items:center;color:rgba(234,240,255,.5);">
          Mini chart placeholder
        </div>
      </div>
    </div>

  </div>

  <div class="footer-space"></div>
</div>

<div class="scroll-btn" id="scrollUp">‚Üë</div>
<div class="scroll-btn" id="scrollDown">‚Üì</div>

<div class="bottom-nav">
  <a class="navbtn active" href="#">Home</a>
  <a class="navbtn" href="#">Market</a>
  <div class="fab">‚Üî</div>
  <a class="navbtn" href="#">Wallet</a>
  <a class="navbtn" href="#">Profile</a>
</div>

<script>
/* =========================
   SUPABASE AUTH + EMAIL GUARD (ONE-BLOCK)
   ========================= */
const SUPABASE_URL = "https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE"; // <-- keep your actual key here
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

(async () => {
  const { data: { session } } = await supabase.auth.getSession();

  // Not logged in ‚Üí go login
  if(!session?.user){
    window.location.href = "login.html";
    return;
  }

  // Email not verified ‚Üí go verify
  if(!session.user.email_confirmed_at){
    window.location.href = "verify.html";
    return;
  }

  // Show user email
  document.getElementById("userEmail").textContent = session.user.email;

})();

/* =========================
   UTILITIES
   ========================= */
function formatMoney(num){
  const n = Number(num);
  if(!isFinite(n)) return "$0.00";
  return n.toLocaleString(undefined, { style:"currency", currency:"USD" });
}
function formatNumber(num, digits=2){
  const n = Number(num);
  if(!isFinite(n)) return "0";
  return n.toLocaleString(undefined, { minimumFractionDigits:digits, maximumFractionDigits:digits });
}

/* =========================
   COUNTRY INDICATOR
   ========================= */
(async()=>{
  try{
    const res = await fetch("https://ipapi.co/json/");
    const j = await res.json();
    const flag = j?.country_code ? `üá≥üá¨` : "üåç"; // keep simple, don‚Äôt alter layout
    document.getElementById("countryIndicator").textContent = `${flag} ${j.city || "Unknown"}, ${j.country_name || ""}`.trim();
  }catch(e){
    document.getElementById("countryIndicator").textContent = "üåç Region unavailable";
  }
})();

/* =========================
   LIVE PRICE (same style)
   ========================= */
let priceWS = null;
async function startPriceStream(symbol){
  try{ if(priceWS) priceWS.close(); }catch(e){}
  const url = `wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@ticker`;
  priceWS = new WebSocket(url);

  const dot = document.getElementById("connDot");
  const connText = document.getElementById("connText");

  priceWS.onopen = ()=>{ dot.style.background="var(--ok)"; connText.textContent="Connected"; };
  priceWS.onerror = ()=>{ dot.style.background="var(--err)"; connText.textContent="Error"; };
  priceWS.onclose = ()=>{ dot.style.background="var(--warn)"; connText.textContent="Disconnected"; };

  priceWS.onmessage = (ev)=>{
    const data = JSON.parse(ev.data);
    const p = Number(data.c);
    const change = Number(data.P);

    document.getElementById("livePrice").textContent = formatMoney(p);
    const ch = document.getElementById("liveChange");
    ch.textContent = `${change.toFixed(2)}%`;
    ch.style.borderColor = "transparent";
    ch.style.background = change>=0 ? "rgba(34,197,94,.12)" : "rgba(239,68,68,.12)";
  };
}
startPriceStream("BTCUSDT");

document.getElementById("symbolSelect").addEventListener("change",(e)=>{
  const symbol = e.target.value;
  startPriceStream(symbol);
  startOrderBook(symbol); // sync order book
});

/* =========================
   ‚úÖ FIXED ORDER BOOK (WORKS IN BROWSER)
   Uses Binance WebSocket depth stream (NO CORS ISSUES)
   ========================= */
let obWS = null;

function clearBook(){
  document.getElementById("bids").innerHTML = "";
  document.getElementById("asks").innerHTML = "";
}

function renderSide(containerId, levels, sideClass){
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  let total = 0;

  for(const [price, qty] of levels){
    const p = Number(price);
    const q = Number(qty);
    total += q;

    const row = document.createElement("div");
    row.className = "level";
    row.innerHTML = `
      <div class="price ${sideClass}">${formatNumber(p, 2)}</div>
      <div>${formatNumber(q, 6)}</div>
      <div>${formatNumber(total, 6)}</div>
    `;
    el.appendChild(row);
  }
}

function startOrderBook(symbol){
  const status = document.getElementById("orderBookStatus");
  status.textContent = "Loading order book...";
  clearBook();

  // Close previous
  try{ if(obWS) obWS.close(); }catch(e){}

  // Binance depth stream: top 20 levels
  const url = `wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@depth20@100ms`;
  obWS = new WebSocket(url);

  obWS.onopen = ()=>{
    status.textContent = "Order book live ‚úÖ";
  };

  obWS.onerror = ()=>{
    status.textContent = "Order book error ‚ùå";
  };

  obWS.onclose = ()=>{
    status.textContent = "Order book disconnected";
  };

  obWS.onmessage = (ev)=>{
    const data = JSON.parse(ev.data);

    // data.bids, data.asks are arrays: [price, qty]
    const bids = (data.bids || []).slice(0, 20);
    const asks = (data.asks || []).slice(0, 20);

    // Sort: bids desc, asks asc
    bids.sort((a,b)=>Number(b[0]) - Number(a[0]));
    asks.sort((a,b)=>Number(a[0]) - Number(b[0]));

    renderSide("bids", bids, "bid");
    renderSide("asks", asks, "ask");
  };
}
startOrderBook("BTCUSDT");

/* =========================
   PORTFOLIO (unchanged style)
   ========================= */
document.getElementById("portfolioValue").textContent = formatMoney(0);

/* =========================
   SCROLL BUTTONS
   ========================= */
document.getElementById("scrollUp").onclick = ()=> window.scrollTo({top:0,behavior:"smooth"});
document.getElementById("scrollDown").onclick = ()=> window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"});
</script>

</body>
</html>
