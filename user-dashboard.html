<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Coinluxora User Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#050a18;
  --stroke:rgba(255,255,255,.12);
  --text:#eaf0ff;
  --muted:rgba(234,240,255,.65);

  --ok:#22c55e;
  --err:#f87171;

  --blue:#5b6cff;
  --purple:#7c4dff;
  --green:#34d399;
  --cyan:#38bdf8;
  --pink:#ff4da6;

  --shadow: 0 26px 90px rgba(0,0,0,.55);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  padding:16px;
  padding-bottom:140px;
  overflow-x:hidden;
  background: var(--bg);
}

/* ===== UPPER ECHELON BACKGROUND ===== */
.bgFlow{
  position:fixed; inset:0; z-index:-4;
  background:
    radial-gradient(900px 520px at 10% 10%, rgba(83,113,255,.30), transparent 55%),
    radial-gradient(900px 520px at 90% 20%, rgba(52,211,153,.20), transparent 55%),
    radial-gradient(900px 520px at 40% 92%, rgba(255,77,166,.16), transparent 60%),
    linear-gradient(180deg, rgba(5,10,24,1), rgba(2,6,23,1));
}
.blob{
  position:fixed;
  width:520px;height:520px;border-radius:999px;
  filter: blur(72px);
  opacity:.60;
  z-index:-3;
  mix-blend-mode: screen;
  will-change: transform;
}
.blob.b1{ background: rgba(91,108,255,.92); left:-150px; top:-160px; animation: drift1 10s ease-in-out infinite; }
.blob.b2{ background: rgba(124,77,255,.82); right:-220px; top:5%; animation: drift2 12s ease-in-out infinite; }
.blob.b3{ background: rgba(52,211,153,.55); left:10%; bottom:-250px; animation: drift3 14s ease-in-out infinite; }
.blob.b4{ background: rgba(255,77,166,.58); right:10%; bottom:-260px; animation: drift4 11s ease-in-out infinite; }
@keyframes drift1{0%{transform:translate(0,0) scale(1)}50%{transform:translate(250px,140px) scale(1.10)}100%{transform:translate(0,0) scale(1)}}
@keyframes drift2{0%{transform:translate(0,0) scale(1)}50%{transform:translate(-280px,170px) scale(1.14)}100%{transform:translate(0,0) scale(1)}}
@keyframes drift3{0%{transform:translate(0,0) scale(1)}50%{transform:translate(210px,-210px) scale(1.10)}100%{transform:translate(0,0) scale(1)}}
@keyframes drift4{0%{transform:translate(0,0) scale(1)}50%{transform:translate(-180px,-130px) scale(1.09)}100%{transform:translate(0,0) scale(1)}}

.shimmer{
  position:fixed; inset:-30px; z-index:-2;
  opacity:.28;
  background:
    radial-gradient(600px 280px at 30% 10%, rgba(255,255,255,.10), transparent 60%),
    radial-gradient(700px 320px at 80% 60%, rgba(255,255,255,.07), transparent 60%),
    linear-gradient(120deg, transparent, rgba(255,255,255,.05), transparent);
  animation: shimmerMove 6s ease-in-out infinite alternate;
  pointer-events:none;
}
@keyframes shimmerMove{from{transform:translateY(0px) translateX(0px)}to{transform:translateY(42px) translateX(22px)}}

.container{max-width:920px;margin:0 auto}

/* ===== Loading Gate ===== */
#authGate{
  position:fixed; inset:0; z-index:99999;
  display:flex; align-items:center; justify-content:center;
  background:
    radial-gradient(900px 420px at 10% 0%, rgba(83,113,255,.22), transparent 55%),
    radial-gradient(900px 420px at 90% 0%, rgba(52,211,153,.18), transparent 55%),
    var(--bg);
}
.gateCard{
  width:min(520px,92vw);
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.25);
  border-radius:22px;
  padding:18px;
  box-shadow:0 26px 90px rgba(0,0,0,.55);
  backdrop-filter: blur(14px);
  text-align:center;
}
.gateLogo{
  width:62px;height:62px;border-radius:18px;
  margin:0 auto 10px;
  display:grid;place-items:center;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(109,87,255,1), rgba(124,77,255,1));
  box-shadow:0 18px 50px rgba(109,87,255,.28);
  font-size:28px;font-weight:1000;
}
.gateTxt{font-weight:1000}
.gateSub{margin-top:6px;color:rgba(234,240,255,.70);font-weight:900;font-size:13px}
.spinner{
  width:46px;height:46px;margin:14px auto 0;
  border-radius:999px;
  border:3px solid rgba(255,255,255,.18);
  border-top-color:#9bdcff;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ============================================================
   ‚úÖ STICKY MENU POLISH
   ============================================================ */
.stickyMenu{
  position:sticky;
  top:12px;
  z-index:3000;
  margin-bottom:10px;
}
.stickyMenu::before{
  content:"";
  position:absolute;
  inset:-10px -10px -8px -10px;
  border-radius:26px;
  background:rgba(5,10,24,.58);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 18px 70px rgba(0,0,0,.55);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  z-index:-1;
  pointer-events:none;
  opacity:0;
  transform: translateY(-6px);
  transition: .18s ease;
}
.stickyMenu.isStuck::before{ opacity:1; transform: translateY(0); }
.stickyMenu.isStuck .topRow{ margin-bottom:8px; }

/* ===== TOP BAR ===== */
.topRow{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; margin-bottom:14px;
}
.brand{
  display:flex;align-items:center;gap:12px;
  padding:12px 14px;border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(90deg, rgba(109,87,255,1), rgba(135,116,255,0.86));
  color:white;font-weight:1000;letter-spacing:.6px;
  box-shadow:0 18px 50px rgba(109,87,255,.25);
  min-width:140px;
}
.brandIcon{
  width:34px;height:34px;border-radius:12px;
  background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.22);
  display:grid;place-items:center;
  font-weight:1000;
}
.headerActions{display:flex;gap:10px;align-items:center}

/* ‚úÖ Avatar */
.avatarBtn{
  width:46px;height:46px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(124,77,255,1), rgba(109,87,255,1));
  cursor:pointer;
  box-shadow:0 16px 40px rgba(124,77,255,.32);
  display:grid;place-items:center;
  position:relative;overflow:hidden;
}
.avatarBtn:hover{filter:brightness(1.05)}
.avatarFallback{font-size:18px;line-height:1;z-index:2;}
.avatarImgBtn{position:absolute; inset:0;width:100%; height:100%;object-fit:cover;display:none;z-index:3;}

.iconBtn{
  width:46px;height:46px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:white;font-weight:1000;
  cursor:pointer;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
  backdrop-filter: blur(10px);
}
.iconBtn:hover{background:rgba(255,255,255,.08)}

/* ===== HELLO CARD ===== */
.helloCard{
  border-radius:20px;
  padding:16px 16px;
  overflow:hidden;
  background:
    radial-gradient(800px 220px at 20% 20%, rgba(255,255,255,.18), transparent 60%),
    linear-gradient(90deg, rgba(109,87,255,1), rgba(255,77,166,0.98));
  color:white;
  box-shadow:0 22px 70px rgba(109,87,255,.22);
  display:flex;align-items:center;justify-content:space-between;gap:12px;
}
.helloLeft{display:flex;align-items:center;gap:12px;}
.helloLogo{
  width:48px;height:48px;border-radius:18px;
  background:rgba(255,255,255,.20);
  border:1px solid rgba(255,255,255,.22);
  display:grid;place-items:center;
  font-weight:1000;
}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.miniChip{
  font-size:12px;font-weight:1000;
  padding:6px 10px;border-radius:999px;
  background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.22);
  display:flex;gap:6px;align-items:center;
}
.helloTitle{font-weight:1000;font-size:18px}
.helloSub{font-size:12px;font-weight:900;opacity:.92}
.helloRight{
  display:flex;flex-direction:column;align-items:flex-end;gap:8px;
}
.helloRightTop{display:flex;align-items:center;gap:10px}
.idChip{
  padding:8px 12px;border-radius:999px;
  background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.22);
  font-weight:1000;font-size:12px;
}
.logoutBtn{
  width:46px;height:46px;border-radius:999px;border:none;
  cursor:pointer;
  background:rgba(239,68,68,0.95);
  color:#fff;
  font-weight:1000;
  box-shadow:0 16px 40px rgba(239,68,68,.22);
}
.datetimeChip{
  padding:6px 10px;border-radius:999px;
  background:rgba(255,255,255,.16);
  border:1px solid rgba(255,255,255,.20);
  font-weight:1000;font-size:12px;
  color:#fff;
  white-space:nowrap;
}

/* ===== BOX ===== */
.box{
  border:1px solid rgba(255,255,255,.12);
  border-radius:24px;
  padding:16px;
  background:
    radial-gradient(700px 220px at 12% 10%, rgba(56,189,248,.14), transparent 62%),
    radial-gradient(700px 220px at 88% 18%, rgba(255,77,166,.10), transparent 62%),
    linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  box-shadow:0 26px 90px rgba(0,0,0,.55);
  backdrop-filter: blur(12px);
  margin-top:14px;
}
.box h2{margin:0;font-size:20px;font-weight:1000}
.small{color:var(--muted);font-size:13px;margin-top:8px}
.ok{color:var(--ok);font-weight:1000}
.err{color:var(--err);font-weight:1000}
.card{
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:12px;
  background:rgba(0,0,0,.22);
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}

/* ‚úÖ highlight polish on touch */
.box, .balanceCard, .cryptoRow, .action, .card, .chartWrap, .obRow{
  -webkit-tap-highlight-color: transparent;
}

/* ===== balanceCard ===== */
.balanceCard{
  margin-top:14px;
  border-radius:24px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(900px 400px at 15% 20%, rgba(0,0,0,0.55), transparent 55%),
    radial-gradient(900px 400px at 70% 20%, rgba(52,211,153,.24), transparent 55%),
    linear-gradient(135deg, rgba(3,7,18,0.92), rgba(15,23,42,0.84));
  color:white;
  box-shadow: 0 26px 60px rgba(0,0,0,0.25);
  padding:16px;
}
.bTitle{font-size:13px;font-weight:1000;opacity:.85}
.bValue{font-size:34px;font-weight:1000;margin-top:8px}
.bHint{margin-top:6px;font-size:13px;font-weight:900;opacity:.88;display:flex;gap:10px;align-items:center}
.dot{width:10px;height:10px;border-radius:999px;background:var(--green)}
.actionGrid{
  margin-top:16px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}
.action{
  border-radius:18px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
  padding:12px;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  gap:8px;
  cursor:pointer;
  transition:.18s ease;
}
.action:hover{transform: translateY(-2px);background:rgba(255,255,255,.10)}
.aIcon{
  width:48px;height:48px;border-radius:999px;
  display:grid;place-items:center;
  font-size:20px;
  font-weight:1000;color:#fff;
}
.aSend{background:linear-gradient(180deg,#6d57ff,#7c4dff)}
.aReceive{background:linear-gradient(180deg,#18c07b,#11b981)}
.aPlans{background:linear-gradient(180deg,#f59e0b,#f97316)}
.aSupport{background:linear-gradient(180deg,#38bdf8,#5b6cff)}
.aText{font-weight:1000;font-size:13px}

/* ===== converters ===== */
.convGrid{margin-top:14px;display:grid;gap:12px}
.convRow{display:flex;gap:10px;flex-wrap:wrap}
.inp{
  flex:1;min-width:140px;
  height:50px;border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  color:var(--text);
  padding:10px 12px;
  font-weight:1000;
  outline:none;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}
.swapBtn{
  width:54px;height:50px;border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.08);
  color:#fff;
  font-weight:1000;
  cursor:pointer;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}
.swapBtn:hover{filter:brightness(1.05)}
.convBtn{
  width:100%;
  height:54px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(180deg, rgba(91,108,255,1), rgba(124,77,255,1));
  color:white;
  font-weight:1000;
  cursor:pointer;
  box-shadow:0 18px 55px rgba(91,108,255,.18);
  display:flex;align-items:center;justify-content:center;gap:10px;
}
.convBtn:hover{filter:brightness(1.05)}
.rateLine{
  margin-top:10px;
  font-size:12px;
  color:rgba(234,240,255,.75);
  font-weight:900;
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}
.rateDot{
  width:10px;height:10px;border-radius:999px;
  background:rgba(52,211,153,1);
  box-shadow:0 0 18px rgba(52,211,153,.55);
}

/* ===== searchable dropdown unlimited ===== */
.ddWrap{flex:1;min-width:220px;position:relative}
.ddBtn{
  width:100%;
  height:50px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  color:rgba(234,240,255,.95);
  padding:10px 12px;
  font-weight:1000;
  outline:none;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.ddLeft{display:flex;align-items:center;gap:10px;min-width:0}
.ddIcon{
  width:34px;height:34px;border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  display:grid;place-items:center;
  font-size:14px;
}
.ddName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ddPanel{
  position:absolute; top:56px; left:0; right:0;
  z-index:100;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(2,6,23,.94);
  box-shadow:0 26px 90px rgba(0,0,0,.65);
  backdrop-filter: blur(16px);
  overflow:hidden;
  display:none;
}
.ddPanel.show{display:block;}
.ddSearch{
  width:100%;
  height:46px;
  border:none; outline:none;
  padding:0 12px;
  font-weight:1000;
  color:#fff;
  background:rgba(0,0,0,.20);
  border-bottom:1px solid rgba(255,255,255,.10);
}
.ddList{max-height:320px;overflow:auto;}
.ddItem{
  padding:12px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  cursor:pointer;
  border-bottom:1px solid rgba(255,255,255,.06);
  color:rgba(234,240,255,.86);
  font-weight:900;
}
.ddItem:hover{background:rgba(255,255,255,.06)}
.ddItem small{color:rgba(234,240,255,.55);font-weight:900}

/* ===== mini chart ===== */
.chartWrap{
  margin-top:12px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  overflow:hidden;
  background:rgba(0,0,0,.22);
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}
.chartHead{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.10);
  font-weight:1000;
  color:rgba(234,240,255,.78);
  font-size:13px;
}
.chartFrame{width:100%;height:340px;border:0;display:block}

/* ===== ORDER BOOK ===== */
.orderBookWrap{
  margin-top:12px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  overflow:hidden;
  background:rgba(0,0,0,.22);
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}
.obHead{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.10);
  font-weight:1000;
  color:rgba(234,240,255,.78);
  font-size:13px;
}
.obStatus{
  display:flex;gap:8px;align-items:center;font-weight:1000;font-size:12px;color:rgba(234,240,255,.70);
}
.pulseDot{
  width:9px;height:9px;border-radius:999px;background:rgba(34,197,94,1);
  box-shadow:0 0 18px rgba(34,197,94,.55);
  animation:pulse 1.3s ease-in-out infinite;
}
@keyframes pulse{0%{transform:scale(.85);opacity:.7}50%{transform:scale(1.1);opacity:1}100%{transform:scale(.85);opacity:.7}}

.obGrid{
  display:grid;
  grid-template-columns: 1fr 90px 1fr;
  gap:10px;
  padding:12px;
}
@media (max-width:720px){
  .obGrid{ grid-template-columns:1fr; }
}
.obCol{
  border:1px solid rgba(255,255,255,.10);
  border-radius:16px;
  overflow:hidden;
  background:rgba(0,0,0,.18);
}
.obColHead{
  display:flex;justify-content:space-between;gap:10px;
  padding:10px 10px;
  font-weight:1000;font-size:12px;
  border-bottom:1px solid rgba(255,255,255,.08);
  color:rgba(234,240,255,.75);
}
.obRows{
  max-height:320px;
  overflow:auto;
}
.obRow{
  position:relative;
  display:grid;
  grid-template-columns: 1.15fr 1fr 1fr;
  gap:10px;
  padding:8px 10px;
  font-weight:1000;
  font-size:12px;
  border-bottom:1px solid rgba(255,255,255,.06);
}
.obRow:last-child{border-bottom:none}
.obRow span{z-index:2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.obRow.ask .p{color:#f87171}
.obRow.bid .p{color:#22c55e}
.obRow .bgBar{
  position:absolute; inset:0;
  z-index:1;
  opacity:.14;
}
.obRow.ask .bgBar{ background:linear-gradient(90deg, rgba(248,113,113,.0), rgba(248,113,113,.55)); transform-origin:right; }
.obRow.bid .bgBar{ background:linear-gradient(90deg, rgba(34,197,94,.55), rgba(34,197,94,.0)); transform-origin:left; }
.obMid{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:10px 0;
}
.midPrice{ font-weight:1000; font-size:15px; }
.spreadPill{
  font-size:11px;
  font-weight:1000;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.08);
  color:rgba(234,240,255,.80);
}
.obFoot{
  padding:10px 12px;
  border-top:1px solid rgba(255,255,255,.10);
  display:flex;justify-content:space-between;gap:10px;
  color:rgba(234,240,255,.65);
  font-size:12px;font-weight:900;
}

/* ===== DOCK ===== */
.dock{
  position:fixed;
  left:0; right:0; bottom:14px;
  z-index:2000;
  pointer-events:none;
}
.dockInner{ pointer-events:auto; max-width:980px; margin:0 auto; padding:0 14px; }
.dockBar{
  height:76px;
  border-radius:28px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 20px 70px rgba(0,0,0,.45);
  backdrop-filter: blur(14px);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  gap:10px;
}
.dockItem{
  flex:1;
  min-width:70px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:6px;
  border-radius:18px;
  padding:10px 0;
  color:rgba(234,240,255,.55);
  font-size:12px;
  font-weight:1000;
  cursor:pointer;
  user-select:none;
  position:relative;
}
.dockItem .ico{font-size:18px;opacity:.95}
.dockItem:hover{background:rgba(255,255,255,.06)}
.dockHome{
  width:78px;height:78px;border-radius:26px;
  background:linear-gradient(180deg, rgba(109,87,255,1), rgba(91,108,255,1));
  box-shadow:0 22px 55px rgba(109,87,255,.30);
  display:grid;place-items:center;
  margin-top:-32px;
  border:1px solid rgba(255,255,255,.16);
  cursor:pointer;user-select:none;
  flex:0 0 auto;
  pointer-events:auto;
}
.dockHome span{font-size:28px;color:white}
</style>
</head>

<body>
<div class="bgFlow"></div>
<div class="blob b1"></div>
<div class="blob b2"></div>
<div class="blob b3"></div>
<div class="blob b4"></div>
<div class="shimmer"></div>

<!-- Loading -->
<div id="authGate">
  <div class="gateCard">
    <div class="gateLogo">üì£</div>
    <div class="gateTxt">Coinluxora</div>
    <div class="gateSub">Securing your session‚Ä¶</div>
    <div class="spinner"></div>
  </div>
</div>

<div class="container">
  <div id="stickyMenu" class="stickyMenu">
    <div class="topRow">
      <div class="brand"><div class="brandIcon">üì£</div>COIN</div>
      <div class="headerActions">
        <button class="avatarBtn" onclick="goProfile()" title="Profile">
          <span id="avatarFallback" class="avatarFallback">üë§</span>
          <img id="avatarImgBtn" class="avatarImgBtn" alt="Avatar"/>
        </button>
        <button class="iconBtn" onclick="openMenu()" title="Menu">‚ò∞</button>
      </div>
    </div>
  </div>

  <div class="helloCard">
    <div class="helloLeft">
      <div class="helloLogo">üí´</div>
      <div>
        <div class="chips">
          <div class="miniChip">üü¢ active</div>
          <div class="miniChip" id="countryChip" style="display:none"></div>
        </div>
        <div class="helloTitle" id="greetingTitle">Greetings‚Ä¶</div>
        <div class="helloSub" id="helloName">Loading‚Ä¶</div>
      </div>
    </div>

    <div class="helloRight">
      <div class="helloRightTop">
        <div class="idChip" id="userIdChip">ID:</div>
        <button class="logoutBtn" onclick="logout()" title="Logout">‚éã</button>
      </div>
      <div class="datetimeChip" id="dateTimeNow">--- | ---</div>
    </div>
  </div>

  <div class="box">
    <h2>Live Crypto Order Book</h2>
    <div class="small">Real-time Binance WebSocket (NO CORS issues).</div>

    <div class="convRow" style="margin-top:12px">
      <select id="obPair" class="inp" style="min-width:220px">
        <option value="BTCUSDT">BTC/USDT</option>
        <option value="ETHUSDT">ETH/USDT</option>
        <option value="BNBUSDT">BNB/USDT</option>
        <option value="XRPUSDT">XRP/USDT</option>
        <option value="SOLUSDT">SOL/USDT</option>
      </select>
    </div>

    <div class="chartWrap">
      <div class="chartHead">
        <span>Mini Candlestick Chart</span>
        <span id="chartPair">BTC/USDT</span>
      </div>
      <iframe id="tvChart" class="chartFrame"></iframe>
    </div>

    <div class="orderBookWrap">
      <div class="obHead">
        <span>Order Book</span>
        <div class="obStatus">
          <span class="pulseDot"></span>
          <span id="obStatusTxt">Connecting‚Ä¶</span>
        </div>
      </div>

      <div class="obGrid">
        <div class="obCol">
          <div class="obColHead"><span>Asks</span><span>Price / Amount / Total</span></div>
          <div id="obAsks" class="obRows"></div>
        </div>

        <div class="obMid">
          <div class="midPrice" id="obMidPrice">--</div>
          <div class="spreadPill" id="obSpread">Spread: --</div>
        </div>

        <div class="obCol">
          <div class="obColHead"><span>Bids</span><span>Price / Amount / Total</span></div>
          <div id="obBids" class="obRows"></div>
        </div>
      </div>

      <div class="obFoot">
        <div id="obExchange">Source: Binance WS</div>
        <div id="obUpdated">Updated: --</div>
      </div>
    </div>
  </div>
</div>

<div class="dock">
  <div class="dockInner">
    <div class="dockBar">
      <div class="dockItem" onclick="goDepositAndClear()"><div class="ico">üí≥</div><div>Deposit</div></div>
      <div class="dockItem" onclick="goWithdrawAndClear()"><div class="ico">‚û°</div><div>Withdraw</div></div>
      <div class="dockHome" onclick="goDashboard()"><span>üè†</span></div>
      <div class="dockItem" onclick="goPlans()"><div class="ico">üíº</div><div>Plans</div></div>
      <div class="dockItem" onclick="goProfile()"><div class="ico">üë§</div><div>Profile</div></div>
    </div>
  </div>
</div>

<script>
/* ============================
   ‚úÖ STICKY MENU
   ============================ */
(function(){
  const sticky = document.getElementById("stickyMenu");
  if(!sticky) return;
  const onScroll = ()=>{
    if(window.scrollY > 14) sticky.classList.add("isStuck");
    else sticky.classList.remove("isStuck");
  };
  onScroll();
  window.addEventListener("scroll", onScroll, {passive:true});
})();

/* ============================================================
   ‚úÖ AUTH GUARD + EMAIL VERIFY
   ============================================================ */
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";
const supabaseClient=supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

(async function authGuard(){
  try{
    const { data: sessionData } = await supabaseClient.auth.getSession();
    const session = sessionData?.session;
    if(!session){ window.location.replace("login.html"); return; }

    const { data, error } = await supabaseClient.auth.getUser();
    const user = data?.user;
    if(error || !user){ window.location.replace("login.html"); return; }

    if(!user.email_confirmed_at){
      await supabaseClient.auth.signOut();
      window.location.replace("verify.html?status=unverified");
      return;
    }

    document.getElementById("authGate").style.display="none";
    initOrderBook();
    loadChart();
  }catch(e){
    window.location.replace("login.html");
  }
})();

/* ============================
   ‚úÖ CHART
   ============================ */
function loadChart(){
  const pair=document.getElementById("obPair").value;
  const base=pair.replace("USDT","").toUpperCase();
  const tvSymbol = `BINANCE:${base}USDT`;
  document.getElementById("chartPair").textContent = `${base}/USDT`;
  document.getElementById("tvChart").src =
    `https://s.tradingview.com/widgetembed/?symbol=${encodeURIComponent(tvSymbol)}&interval=60&theme=dark&style=1&hidesidetoolbar=1`;
}

/* ============================
   ‚úÖ ORDER BOOK WEBSOCKET
   ============================ */
let obWS=null;

function nfmt(n, dp=2){
  return Number(n).toLocaleString(undefined,{minimumFractionDigits:dp, maximumFractionDigits:dp});
}
function setOBStatus(text, ok=true){
  const el=document.getElementById("obStatusTxt");
  if(!el) return;
  el.textContent=text;
  el.style.color = ok ? "rgba(234,240,255,.75)" : "rgba(248,113,113,1)";
}
function setUpdated(){
  const up=document.getElementById("obUpdated");
  if(up) up.textContent = "Updated: " + new Date().toLocaleTimeString();
}

function renderOB(asks, bids){
  const aEl=document.getElementById("obAsks");
  const bEl=document.getElementById("obBids");
  if(!aEl || !bEl) return;

  const depthA=asks.slice(0,18);
  const depthB=bids.slice(0,18);

  const maxAsk = Math.max(...depthA.map(x=>x.q), 0.0000001);
  const maxBid = Math.max(...depthB.map(x=>x.q), 0.0000001);

  const asksSorted=[...depthA].sort((x,y)=>y.p-x.p);
  const bidsSorted=[...depthB].sort((x,y)=>y.p-x.p);

  let askTotal=0;
  aEl.innerHTML = asksSorted.map(x=>{
    askTotal += x.q;
    const w = Math.min(100, (x.q/maxAsk)*100);
    return `
      <div class="obRow ask">
        <div class="bgBar" style="transform:scaleX(${w/100});"></div>
        <span class="p">${nfmt(x.p, x.p<1?8:2)}</span>
        <span>${nfmt(x.q, x.q<1?6:4)}</span>
        <span>${nfmt(askTotal, askTotal<1?6:4)}</span>
      </div>
    `;
  }).join("");

  let bidTotal=0;
  bEl.innerHTML = bidsSorted.map(x=>{
    bidTotal += x.q;
    const w = Math.min(100, (x.q/maxBid)*100);
    return `
      <div class="obRow bid">
        <div class="bgBar" style="transform:scaleX(${w/100});"></div>
        <span class="p">${nfmt(x.p, x.p<1?8:2)}</span>
        <span>${nfmt(x.q, x.q<1?6:4)}</span>
        <span>${nfmt(bidTotal, bidTotal<1?6:4)}</span>
      </div>
    `;
  }).join("");

  const bestAsk = asks.length ? Math.min(...asks.map(x=>x.p)) : 0;
  const bestBid = bids.length ? Math.max(...bids.map(x=>x.p)) : 0;
  const mid = (bestAsk && bestBid) ? ((bestAsk + bestBid)/2) : 0;
  const spread = (bestAsk && bestBid) ? (bestAsk - bestBid) : 0;

  document.getElementById("obMidPrice").textContent = mid ? nfmt(mid, mid<1?8:2) : "--";
  document.getElementById("obSpread").textContent = spread ? `Spread: ${nfmt(spread, spread<1?8:4)}` : "Spread: --";
  setUpdated();
}

function initOrderBook(){
  connectOB();
  document.getElementById("obPair").addEventListener("change",()=>{
    loadChart();
    connectOB(true);
  });
}

function connectOB(reconnect=false){
  try{
    if(obWS){ obWS.close(); obWS=null; }
  }catch{}

  const pair=(document.getElementById("obPair").value || "BTCUSDT").toLowerCase();
  const wsUrl = `wss://stream.binance.com:9443/ws/${pair}@depth20@100ms`;

  setOBStatus(reconnect ? "Switching pair‚Ä¶" : "Connecting‚Ä¶", true);

  obWS=new WebSocket(wsUrl);

  obWS.onopen=()=>{
    setOBStatus("Live", true);
  };

  obWS.onerror=()=>{
    setOBStatus("WebSocket blocked (network)", false);
  };

  obWS.onclose=()=>{
    setOBStatus("Disconnected‚Ä¶ reconnecting", false);
    setTimeout(()=>connectOB(true), 1600);
  };

  obWS.onmessage=(ev)=>{
    try{
      const j=JSON.parse(ev.data);
      const asks=(j?.a||[]).map(x=>({p:Number(x[0]), q:Number(x[1])})).filter(v=>v.p>0 && v.q>0);
      const bids=(j?.b||[]).map(x=>({p:Number(x[0]), q:Number(x[1])})).filter(v=>v.p>0 && v.q>0);
      if(!asks.length || !bids.length) return;
      renderOB(asks, bids);
    }catch{}
  };
}

/* NAV stubs */
function goPlans(){ window.location.href="plans.html"; }
function goProfile(){ window.location.href="profile.html"; }
function goDepositAndClear(){ window.location.href="deposits.html"; }
function goWithdrawAndClear(){ window.location.href="withdraw.html"; }
function goDashboard(){ window.scrollTo({top:0,behavior:"smooth"}); }
function openMenu(){ /* menu not needed for this demo snippet */ }
async function logout(){ await supabaseClient.auth.signOut(); window.location.replace("login.html"); }
</script>

</body>
</html>
