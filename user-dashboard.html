<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Coinluxora User Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#050a18;
  --stroke:rgba(255,255,255,.12);
  --text:#eaf0ff;
  --muted:rgba(234,240,255,.65);

  --ok:#22c55e;
  --err:#f87171;

  --blue:#5b6cff;
  --purple:#7c4dff;
  --green:#34d399;
  --cyan:#38bdf8;
  --pink:#ff4da6;

  --shadow: 0 26px 90px rgba(0,0,0,.55);
}

*{box-sizing:border-box}

/* ‚úÖ HARD BLOCK: page hidden until auth verified */
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  padding:16px;
  padding-bottom:140px;
  overflow-x:hidden;
  background: var(--bg);
  visibility:hidden; /* ‚úÖ DO NOT RENDER UI until verified */
}
body.pageReady{ visibility:visible; }

/* ===== UPPER ECHELON BACKGROUND ===== */
.bgFlow{
  position:fixed; inset:0; z-index:-4;
  background:
    radial-gradient(900px 520px at 10% 10%, rgba(83,113,255,.30), transparent 55%),
    radial-gradient(900px 520px at 90% 20%, rgba(52,211,153,.20), transparent 55%),
    radial-gradient(900px 520px at 40% 92%, rgba(255,77,166,.16), transparent 60%),
    linear-gradient(180deg, rgba(5,10,24,1), rgba(2,6,23,1));
}
.blob{
  position:fixed;
  width:520px;height:520px;border-radius:999px;
  filter: blur(72px);
  opacity:.60;
  z-index:-3;
  mix-blend-mode: screen;
  will-change: transform;
}
.blob.b1{ background: rgba(91,108,255,.92); left:-150px; top:-160px; animation: drift1 10s ease-in-out infinite; }
.blob.b2{ background: rgba(124,77,255,.82); right:-220px; top:5%; animation: drift2 12s ease-in-out infinite; }
.blob.b3{ background: rgba(52,211,153,.55); left:10%; bottom:-250px; animation: drift3 14s ease-in-out infinite; }
.blob.b4{ background: rgba(255,77,166,.58); right:10%; bottom:-260px; animation: drift4 11s ease-in-out infinite; }
@keyframes drift1{0%{transform:translate(0,0) scale(1)}50%{transform:translate(250px,140px) scale(1.10)}100%{transform:translate(0,0) scale(1)}}
@keyframes drift2{0%{transform:translate(0,0) scale(1)}50%{transform:translate(-280px,170px) scale(1.14)}100%{transform:translate(0,0) scale(1)}}
@keyframes drift3{0%{transform:translate(0,0) scale(1)}50%{transform:translate(210px,-210px) scale(1.10)}100%{transform:translate(0,0) scale(1)}}
@keyframes drift4{0%{transform:translate(0,0) scale(1)}50%{transform:translate(-180px,-130px) scale(1.09)}100%{transform:translate(0,0) scale(1)}}

.shimmer{
  position:fixed; inset:-30px; z-index:-2;
  opacity:.28;
  background:
    radial-gradient(600px 280px at 30% 10%, rgba(255,255,255,.10), transparent 60%),
    radial-gradient(700px 320px at 80% 60%, rgba(255,255,255,.07), transparent 60%),
    linear-gradient(120deg, transparent, rgba(255,255,255,.05), transparent);
  animation: shimmerMove 6s ease-in-out infinite alternate;
  pointer-events:none;
}
@keyframes shimmerMove{from{transform:translateY(0px) translateX(0px)}to{transform:translateY(42px) translateX(22px)}}

.container{max-width:920px;margin:0 auto}

/* ===== Loading Gate ===== */
#authGate{
  position:fixed; inset:0; z-index:99999;
  display:flex; align-items:center; justify-content:center;
  background:
    radial-gradient(900px 420px at 10% 0%, rgba(83,113,255,.22), transparent 55%),
    radial-gradient(900px 420px at 90% 0%, rgba(52,211,153,.18), transparent 55%),
    var(--bg);
}
.gateCard{
  width:min(520px,92vw);
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.25);
  border-radius:22px;
  padding:18px;
  box-shadow:0 26px 90px rgba(0,0,0,.55);
  backdrop-filter: blur(14px);
  text-align:center;
}
.gateLogo{
  width:62px;height:62px;border-radius:18px;
  margin:0 auto 10px;
  display:grid;place-items:center;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(109,87,255,1), rgba(124,77,255,1));
  box-shadow:0 18px 50px rgba(109,87,255,.28);
  font-size:28px;font-weight:1000;
}
.gateTxt{font-weight:1000}
.gateSub{margin-top:6px;color:rgba(234,240,255,.70);font-weight:900;font-size:13px}
.spinner{
  width:46px;height:46px;margin:14px auto 0;
  border-radius:999px;
  border:3px solid rgba(255,255,255,.18);
  border-top-color:#9bdcff;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== TOP BAR ===== */
.topRow{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;}
.brand{
  display:flex;align-items:center;gap:12px;
  padding:12px 14px;border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(90deg, rgba(109,87,255,1), rgba(135,116,255,0.86));
  color:white;font-weight:1000;letter-spacing:.6px;
  box-shadow:0 18px 50px rgba(109,87,255,.25);
  min-width:140px;
}
.brandIcon{width:34px;height:34px;border-radius:12px;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.22);display:grid;place-items:center;font-weight:1000;}
.headerActions{display:flex;gap:10px;align-items:center}

/* Avatar */
.avatarBtn{
  width:46px;height:46px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(124,77,255,1), rgba(109,87,255,1));
  cursor:pointer;
  box-shadow:0 16px 40px rgba(124,77,255,.32);
  display:grid;place-items:center;
  position:relative;overflow:hidden;
}
.avatarFallback{font-size:18px;line-height:1;z-index:2;}
.avatarImgBtn{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none;z-index:3;}

.iconBtn{
  width:46px;height:46px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:white;font-weight:1000;
  cursor:pointer;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
  backdrop-filter: blur(10px);
}
.iconBtn:hover{background:rgba(255,255,255,.08)}

/* HELLO CARD */
.helloCard{
  border-radius:20px;
  padding:16px;
  overflow:hidden;
  background:
    radial-gradient(800px 220px at 20% 20%, rgba(255,255,255,.18), transparent 60%),
    linear-gradient(90deg, rgba(109,87,255,1), rgba(255,77,166,0.98));
  box-shadow:0 22px 70px rgba(109,87,255,.22);
  display:flex;align-items:center;justify-content:space-between;gap:12px;
}
.helloLeft{display:flex;align-items:center;gap:12px;}
.helloLogo{
  width:48px;height:48px;border-radius:18px;
  background:rgba(255,255,255,.20);
  border:1px solid rgba(255,255,255,.22);
  display:grid;place-items:center;font-weight:1000;
}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.miniChip{font-size:12px;font-weight:1000;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.22);display:flex;gap:6px;align-items:center;}
.helloTitle{font-weight:1000;font-size:18px}
.helloSub{font-size:12px;font-weight:900;opacity:.92}
.helloRight{display:flex;flex-direction:column;align-items:flex-end;gap:8px;}
.helloRightTop{display:flex;align-items:center;gap:10px}
.idChip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.22);font-weight:1000;font-size:12px;}
.logoutBtn{width:46px;height:46px;border-radius:999px;border:none;cursor:pointer;background:rgba(239,68,68,0.95);color:#fff;font-weight:1000;box-shadow:0 16px 40px rgba(239,68,68,.22);}
.datetimeChip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.20);font-weight:1000;font-size:12px;white-space:nowrap;}

/* BOX */
.box{
  border:1px solid rgba(255,255,255,.12);
  border-radius:24px;
  padding:16px;
  background:
    radial-gradient(700px 220px at 12% 10%, rgba(56,189,248,.14), transparent 62%),
    radial-gradient(700px 220px at 88% 18%, rgba(255,77,166,.10), transparent 62%),
    linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  box-shadow:0 26px 90px rgba(0,0,0,.55);
  backdrop-filter: blur(12px);
  margin-top:14px;
}
.box h2{margin:0;font-size:20px;font-weight:1000}
.small{color:var(--muted);font-size:13px;margin-top:8px}
.ok{color:var(--ok);font-weight:1000}
.err{color:var(--err);font-weight:1000}
.card{border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:12px;background:rgba(0,0,0,.22);box-shadow:0 16px 40px rgba(0,0,0,.35);}

.balanceCard{
  margin-top:14px;border-radius:24px;overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(900px 400px at 15% 20%, rgba(0,0,0,0.55), transparent 55%),
    radial-gradient(900px 400px at 70% 20%, rgba(52,211,153,.24), transparent 55%),
    linear-gradient(135deg, rgba(3,7,18,0.92), rgba(15,23,42,0.84));
  box-shadow:0 26px 60px rgba(0,0,0,0.25);
  padding:16px;
}
.bTitle{font-size:13px;font-weight:1000;opacity:.85}
.bValue{font-size:34px;font-weight:1000;margin-top:8px}
.bHint{margin-top:6px;font-size:13px;font-weight:900;opacity:.88;display:flex;gap:10px;align-items:center}
.dot{width:10px;height:10px;border-radius:999px;background:var(--green)}
.actionGrid{margin-top:16px;display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
.action{border-radius:18px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;cursor:pointer;transition:.18s ease;}
.action:hover{transform: translateY(-2px);background:rgba(255,255,255,.10)}
.aIcon{width:48px;height:48px;border-radius:999px;display:grid;place-items:center;font-size:20px;font-weight:1000;color:#fff;}
.aSend{background:linear-gradient(180deg,#6d57ff,#7c4dff)}
.aReceive{background:linear-gradient(180deg,#18c07b,#11b981)}
.aPlans{background:linear-gradient(180deg,#f59e0b,#f97316)}
.aSupport{background:linear-gradient(180deg,#38bdf8,#5b6cff)}
.aText{font-weight:1000;font-size:13px}

/* order book */
.orderWrap{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.obCol{border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);padding:12px;box-shadow:0 16px 40px rgba(0,0,0,.35);}
.obTitle{font-weight:1000;color:rgba(234,240,255,.85);font-size:13px;margin-bottom:10px;display:flex;justify-content:space-between;}
.obList{display:grid;gap:8px;max-height:260px;overflow:auto;padding-right:6px;}
.obItem{display:flex;justify-content:space-between;gap:8px;font-weight:900;font-size:12px;color:rgba(234,240,255,.78);}
@media(max-width:520px){.orderWrap{grid-template-columns:1fr}.actionGrid{grid-template-columns:repeat(2,1fr)}}

/* mini chart */
.chartWrap{margin-top:12px;border-radius:18px;border:1px solid rgba(255,255,255,.12);overflow:hidden;background:rgba(0,0,0,.22);box-shadow:0 16px 40px rgba(0,0,0,.35);}
.chartHead{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10);font-weight:1000;color:rgba(234,240,255,.78);font-size:13px;}
.chartFrame{width:100%;height:340px;border:0;display:block}

/* top10 */
.top10Grid{margin-top:12px;display:grid;gap:10px;}
.top10Item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);box-shadow:0 16px 40px rgba(0,0,0,.35);}
.coinLeft{display:flex;gap:12px;align-items:center;min-width:0;}
.coinLogo{width:44px;height:44px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);overflow:hidden;flex:0 0 auto;}
.coinLogo img{width:100%;height:100%;object-fit:cover;}
.coinMeta{min-width:0}
.coinName{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.coinSym{margin-top:2px;font-size:12px;font-weight:900;color:rgba(234,240,255,.55);}
.coinRight{text-align:right}
.coinPrice{font-weight:1000}
.chg{margin-top:4px;font-size:12px;font-weight:1000;display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);}
.chg.up{color:#22c55e;background:rgba(34,197,94,.12)}
.chg.down{color:#f87171;background:rgba(248,113,113,.10)}

/* overlay + sidebar + dock (kept minimal for flash fix) */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;z-index:999;backdrop-filter:blur(4px);}
.overlay.show{display:block;}
.sidebar{position:fixed;top:0;left:-315px;width:292px;height:100vh;padding:16px;z-index:1000;transition:.28s ease;border-right:1px solid rgba(255,255,255,.10);background:linear-gradient(180deg, rgba(4,8,20,0.98), rgba(2,6,23,0.98));box-shadow:0 26px 90px rgba(0,0,0,.60);backdrop-filter: blur(16px);}
.sidebar.open{left:0;}
.dock{position:fixed;left:0;right:0;bottom:14px;z-index:2000;pointer-events:none;}
.dockInner{pointer-events:auto;max-width:980px;margin:0 auto;padding:0 14px;}
.dockBar{height:76px;border-radius:28px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);box-shadow:0 20px 70px rgba(0,0,0,.45);backdrop-filter: blur(14px);display:flex;align-items:center;justify-content:space-between;padding:10px 12px;gap:10px;}
.dockItem{flex:1;min-width:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;border-radius:18px;padding:10px 0;color:rgba(234,240,255,.55);font-size:12px;font-weight:1000;cursor:pointer;user-select:none;position:relative;}
.dockHome{width:78px;height:78px;border-radius:26px;background:linear-gradient(180deg, rgba(109,87,255,1), rgba(91,108,255,1));box-shadow:0 22px 55px rgba(109,87,255,.30);display:grid;place-items:center;margin-top:-32px;border:1px solid rgba(255,255,255,.16);cursor:pointer;user-select:none;flex:0 0 auto;pointer-events:auto;}
.dockHome span{font-size:28px;color:white}
.dockBadge{position:absolute;top:2px;right:18px;min-width:18px;height:18px;padding:0 6px;border-radius:999px;background:#f87171;color:#020617;font-weight:1000;font-size:11px;display:none;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.18);}
</style>
</head>

<body>
<div class="bgFlow"></div>
<div class="blob b1"></div>
<div class="blob b2"></div>
<div class="blob b3"></div>
<div class="blob b4"></div>
<div class="shimmer"></div>

<!-- Loading Gate (always visible while body hidden) -->
<div id="authGate">
  <div class="gateCard">
    <div class="gateLogo">üì£</div>
    <div class="gateTxt">Coinluxora</div>
    <div class="gateSub">Securing your session‚Ä¶</div>
    <div class="spinner"></div>
  </div>
</div>

<div id="overlay" class="overlay" onclick="closeMenu()"></div>
<div id="sidebar" class="sidebar"></div>

<div class="container">
  <div class="topRow">
    <div class="brand"><div class="brandIcon">üì£</div>COIN</div>
    <div class="headerActions">
      <button class="avatarBtn" onclick="goProfile()" title="Profile">
        <span id="avatarFallback" class="avatarFallback">üë§</span>
        <img id="avatarImgBtn" class="avatarImgBtn" alt="Avatar"/>
      </button>
      <button class="iconBtn" onclick="openMenu()" title="Menu">‚ò∞</button>
    </div>
  </div>

  <div class="helloCard">
    <div class="helloLeft">
      <div class="helloLogo">üì∂</div>
      <div>
        <div class="chips">
          <div class="miniChip">üü¢ active</div>
          <div class="miniChip" id="countryChip" style="display:none"></div>
        </div>
        <div class="helloTitle" id="greetingTitle">Greetings‚Ä¶</div>
        <div class="helloSub" id="helloName">Loading‚Ä¶</div>
      </div>
    </div>

    <div class="helloRight">
      <div class="helloRightTop">
        <div class="idChip" id="userIdChip">ID:</div>
        <button class="logoutBtn" onclick="logout()" title="Logout">‚éã</button>
      </div>
      <div class="datetimeChip" id="dateTimeNow">--- | ---</div>
    </div>
  </div>

  <div class="balanceCard">
    <div class="bTitle">Total Portfolio Value</div>
    <div class="bValue" id="balance">--</div>
    <div class="bHint"><div class="dot"></div> <div>Your trading account balance</div></div>
    <div class="actionGrid">
      <div class="action" onclick="goWithdrawAndClear()"><div class="aIcon aSend">‚úàÔ∏è</div><div class="aText">Send</div></div>
      <div class="action" onclick="goDepositAndClear()"><div class="aIcon aReceive">‚¨áÔ∏è</div><div class="aText">Receive</div></div>
      <div class="action" onclick="goPlans()"><div class="aIcon aPlans">üìà</div><div class="aText">Plans</div></div>
      <div class="action" onclick="goSupportAndClear()"><div class="aIcon aSupport">üí¨</div><div class="aText">Support</div></div>
    </div>
  </div>

  <div class="box">
    <h2>Active Investment Plan</h2>
    <div id="planMsg" class="small">Loading‚Ä¶</div>
    <div id="planBox"></div>
  </div>

  <div class="box">
    <h2>Live Crypto Order Book</h2>
    <div class="small">Auto refresh every 3 seconds. Binance ‚Üí OKX ‚Üí Bybit fallback.</div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
      <select id="obPair" class="inp" style="min-width:220px">
        <option value="BTCUSDT">BTC/USDT</option>
        <option value="ETHUSDT">ETH/USDT</option>
        <option value="BNBUSDT">BNB/USDT</option>
        <option value="XRPUSDT">XRP/USDT</option>
        <option value="SOLUSDT">SOL/USDT</option>
      </select>
      <button class="convBtn" style="height:50px" onclick="loadOrderBook(true)">üîÑ Refresh Now</button>
    </div>

    <div class="orderWrap">
      <div class="obCol">
        <div class="obTitle"><span>üü• Asks</span><span style="color:rgba(234,240,255,.55);font-size:12px">Price | Amount</span></div>
        <div id="asks" class="obList"></div>
      </div>
      <div class="obCol">
        <div class="obTitle"><span>üü© Bids</span><span style="color:rgba(234,240,255,.55);font-size:12px">Price | Amount</span></div>
        <div id="bids" class="obList"></div>
      </div>
    </div>

    <div class="chartWrap">
      <div class="chartHead">
        <span>Mini Candlestick Chart</span>
        <span id="chartPair">BTC/USDT</span>
      </div>
      <iframe id="tvChart" class="chartFrame"></iframe>
    </div>

    <div style="height:12px"></div>
    <h2 style="margin-top:12px">Top 10 Major Crypto</h2>
    <div class="small">Top market cap coins with live price & 24h change.</div>
    <div id="top10Msg" class="small" style="margin-top:8px">Loading top coins‚Ä¶</div>
    <div id="top10List" class="top10Grid"></div>
  </div>
</div>

<div class="dock">
  <div class="dockInner">
    <div class="dockBar">
      <div class="dockItem" onclick="goDepositAndClear()"><div id="badgeDepositDock" class="dockBadge">0</div><div class="ico">üí≥</div><div>Deposit</div></div>
      <div class="dockItem" onclick="goWithdrawAndClear()"><div id="badgeWithdrawDock" class="dockBadge">0</div><div class="ico">‚û°</div><div>Withdraw</div></div>
      <div class="dockHome" onclick="goDashboard()"><span>üè†</span></div>
      <div class="dockItem" onclick="goPlans()"><div class="ico">üíº</div><div>Plans</div></div>
      <div class="dockItem" onclick="goProfile()"><div class="ico">üë§</div><div>Profile</div></div>
    </div>
  </div>
</div>

<script>
/* ============================================================
   ‚úÖ COINLUXORA ONE-BLOCK AUTH + EMAIL VERIFICATION GUARD
   (added in: user-dashboard.html)
   ============================================================ */
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";
const EDGE_CLEAR_BADGE_URL = `${SUPABASE_URL}/functions/v1/clear_badge`;
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let currentUserEmail="";
let currentUserId="";
let badgeChannel=null;

let orderTimer=null;
let top10Timer=null;

/* ‚úÖ sidebar render */
function renderSidebar(){
  const sb=document.getElementById("sidebar");
  sb.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px;">
      <div style="font-weight:1000;font-size:16px;letter-spacing:.9px;padding:10px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:linear-gradient(90deg, rgba(109,87,255,.85), rgba(124,77,255,.85));min-width:170px;">
        ‚óà COINLUXORA
      </div>
      <button onclick="closeMenu()" style="width:44px;height:44px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.22);color:#fff;font-weight:1000;cursor:pointer">‚úï</button>
    </div>

    <a href="user-dashboard.html" style="display:block;margin-bottom:10px;text-decoration:none;color:#cfefff;font-weight:1000;padding:12px;border-radius:18px;border:1px solid rgba(56,189,248,.55);background:linear-gradient(180deg, rgba(56,189,248,0.14), rgba(56,189,248,0.08));">üè† Dashboard</a>
    <a href="portfolio.html" style="display:block;margin-bottom:10px;text-decoration:none;color:rgba(234,240,255,.82);font-weight:1000;padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);">üìä Portfolio</a>
    <a href="deposits.html" style="display:block;margin-bottom:10px;text-decoration:none;color:rgba(234,240,255,.82);font-weight:1000;padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);">üí≥ Deposit</a>
    <a href="withdraw.html" style="display:block;margin-bottom:10px;text-decoration:none;color:rgba(234,240,255,.82);font-weight:1000;padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);">‚û° Withdraw</a>
    <a href="support.html" style="display:block;margin-bottom:10px;text-decoration:none;color:rgba(234,240,255,.82);font-weight:1000;padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);">üßë‚Äçüíª Support</a>
    <a href="plans.html" style="display:block;margin-bottom:10px;text-decoration:none;color:rgba(234,240,255,.82);font-weight:1000;padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);">üíº Plans</a>
    <a href="profile.html" style="display:block;margin-bottom:10px;text-decoration:none;color:rgba(234,240,255,.82);font-weight:1000;padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);">üë§ Profile</a>

    <button onclick="logout()" style="margin-top:10px;width:100%;padding:14px;border-radius:18px;font-weight:1000;border:none;cursor:pointer;background:linear-gradient(90deg, rgba(248,113,113,1), rgba(239,68,68,1));color:#020617;">Logout</button>
  `;
}
renderSidebar();

/* ‚úÖ auth guard */
(async function authGuard(){
  try{
    const { data: sessionData } = await supabaseClient.auth.getSession();
    const session = sessionData?.session;
    if(!session){ window.location.replace("login.html"); return; }

    const { data, error } = await supabaseClient.auth.getUser();
    const user = data?.user;
    if(error || !user){ window.location.replace("login.html"); return; }

    if(!user.email_confirmed_at){
      await supabaseClient.auth.signOut();
      window.location.replace("verify.html?status=unverified");
      return;
    }

    // ‚úÖ VERIFIED: show UI now
    document.body.classList.add("pageReady");
    document.getElementById("authGate").style.display="none";

    currentUserEmail=user.email;
    currentUserId=user.id;

    initWithUser(user);
  }catch(e){
    window.location.replace("login.html");
  }
})();

/* NAV */
function goPlans(){ window.location.href="plans.html"; }
function goProfile(){ window.location.href="profile.html"; }
function goDepositAndClear(){ clearBadge("deposits"); window.location.href="deposits.html"; }
function goWithdrawAndClear(){ clearBadge("withdrawals"); window.location.href="withdraw.html"; }
function goSupportAndClear(){ clearBadge("notifications"); window.location.href="support.html"; }
function goDashboard(){ window.scrollTo({top:0,behavior:"smooth"}); }

function openMenu(){ document.getElementById("sidebar").classList.add("open"); document.getElementById("overlay").classList.add("show"); }
function closeMenu(){ document.getElementById("sidebar").classList.remove("open"); document.getElementById("overlay").classList.remove("show"); }

/* greeting + clock */
function setGreeting(){
  const h = new Date().getHours();
  let text="Greetings", emoji="‚ú®";
  if(h>=5 && h<12){ text="Good Morning"; emoji="üåû"; }
  else if(h>=12 && h<17){ text="Good Afternoon"; emoji="‚òÄÔ∏è"; }
  else { text="Good Evening"; emoji="üåô"; }
  document.getElementById("greetingTitle").textContent = `${text} ${emoji}`;
}
function startClock(){
  const dtEl=document.getElementById("dateTimeNow");
  const days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const tick=()=>{
    const now=new Date();
    const dayName=days[now.getDay()];
    const day=String(now.getDate()).padStart(2,"0");
    const mon=months[now.getMonth()];
    const yr=now.getFullYear();
    let hh=now.getHours();
    const ampm=hh>=12?"PM":"AM";
    hh=hh%12; hh=hh?hh:12;
    const hhs=String(hh).padStart(2,"0");
    const mm=String(now.getMinutes()).padStart(2,"0");
    const ss=String(now.getSeconds()).padStart(2,"0");
    dtEl.textContent=`${dayName}, ${day} ${mon} ${yr} | ${hhs}:${mm}:${ss} ${ampm}`;
  };
  tick(); setInterval(tick,1000);
}

/* badges clear */
async function clearBadge(badge_key){
  try{
    const { data: sessionData } = await supabaseClient.auth.getSession();
    const accessToken = sessionData?.session?.access_token;
    if(!accessToken) return;

    await fetch(EDGE_CLEAR_BADGE_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${accessToken}`,
        "apikey": SUPABASE_ANON_KEY
      },
      body: JSON.stringify({ badge_key })
    });
  }catch(e){}
}

/* balance / plan */
async function loadBalance(){
  const { data } = await supabaseClient.from("users").select("*").eq("email", currentUserEmail).single();
  const bal = Number(data?.balance || 0).toFixed(2);
  document.getElementById("balance").innerHTML = "$" + bal;
}
function money(n){ return "$" + Number(n||0).toFixed(2); }
async function loadActivePlan(){
  const planMsg=document.getElementById("planMsg");
  const planBox=document.getElementById("planBox");

  const { data, error } = await supabaseClient
    .from("investment_plans")
    .select("*")
    .eq("user_email", currentUserEmail)
    .order("created_at",{ascending:false})
    .limit(1);

  if(error){
    planMsg.innerHTML="<span class='err'>"+error.message+"</span>";
    planBox.innerHTML="";
    return;
  }
  if(!data || data.length===0){
    planMsg.innerHTML="<span class='err'>No investment plan started yet.</span>";
    planBox.innerHTML=`<div class="small">Go to <a style="color:#9bdcff;font-weight:1000" href="plans.html">Investment Plans</a> to start.</div>`;
    return;
  }

  planMsg.innerHTML="";
  const plan=data[0];
  const amount=Number(plan.amount||0);
  const roi=Number(plan.roi_percent||0);
  const expected=amount+(amount*(roi/100));

  planBox.innerHTML=`
    <div class="card">
      <strong>${plan.plan_name} Plan</strong>
      <div class="small" style="margin-top:10px">Amount: <strong>${money(amount)}</strong></div>
      <div class="small">ROI: <strong>${roi}%</strong></div>
      <div class="small">Duration: <strong>${plan.duration_days} days</strong></div>
      <div class="small">Expected Return: <strong>${money(expected)}</strong></div>
    </div>
  `;
}

/* order book */
function parsePairForProviders(pair){
  const base=pair.replace("USDT","").replace("USD","");
  return { binance: pair, okx: `${base}-USDT`, bybit: `${base}USDT` };
}
async function tryBinanceOrderBook(symbol){
  const res = await fetch(`https://api.binance.com/api/v3/depth?symbol=${encodeURIComponent(symbol)}&limit=20`);
  const data = await res.json();
  if(!data?.asks || !data?.bids) throw new Error("binance invalid");
  return { asks:data.asks, bids:data.bids };
}
async function tryOKXOrderBook(instId){
  const res = await fetch(`https://www.okx.com/api/v5/market/books?instId=${encodeURIComponent(instId)}&sz=20`);
  const data = await res.json();
  const book = data?.data?.[0];
  if(!book?.asks || !book?.bids) throw new Error("okx invalid");
  return { asks:book.asks, bids:book.bids };
}
async function tryBybitOrderBook(symbol){
  const res = await fetch(`https://api.bybit.com/v5/market/orderbook?category=spot&symbol=${encodeURIComponent(symbol)}&limit=20`);
  const data = await res.json();
  const book = data?.result;
  if(!book?.a || !book?.b) throw new Error("bybit invalid");
  return { asks:book.a, bids:book.b };
}
async function loadOrderBook(force=false){
  const pair=document.getElementById("obPair").value;
  const asksEl=document.getElementById("asks");
  const bidsEl=document.getElementById("bids");
  const meta=parsePairForProviders(pair);

  if(force){
    asksEl.innerHTML="<div class='obItem'>Loading‚Ä¶</div>";
    bidsEl.innerHTML="<div class='obItem'>Loading‚Ä¶</div>";
  }

  try{
    let book=null;
    try{ book=await tryBinanceOrderBook(meta.binance); }
    catch(e1){
      try{ book=await tryOKXOrderBook(meta.okx); }
      catch(e2){ book=await tryBybitOrderBook(meta.bybit); }
    }

    const asks=(book.asks||[]).slice(0,20);
    const bids=(book.bids||[]).slice(0,20);

    asksEl.innerHTML=asks.map(a=>`<div class="obItem"><span>${Number(a[0]).toLocaleString()}</span><span>${Number(a[1]).toFixed(6)}</span></div>`).join("") || "<div class='obItem'>No asks</div>";
    bidsEl.innerHTML=bids.map(b=>`<div class="obItem"><span>${Number(b[0]).toLocaleString()}</span><span>${Number(b[1]).toFixed(6)}</span></div>`).join("") || "<div class='obItem'>No bids</div>";
  }catch(e){
    asksEl.innerHTML="<div class='obItem'>Order book blocked / unavailable</div>";
    bidsEl.innerHTML="<div class='obItem'>Try changing pair</div>";
  }
}
function startOrderAutoRefresh(){
  if(orderTimer) clearInterval(orderTimer);
  orderTimer=setInterval(()=>loadOrderBook(false), 3000);
}
function loadChart(){
  const pair=document.getElementById("obPair").value;
  const base=pair.replace("USDT","").toUpperCase();
  document.getElementById("chartPair").textContent = `${base}/USDT`;
  document.getElementById("tvChart").src =
    `https://s.tradingview.com/widgetembed/?symbol=${encodeURIComponent("BINANCE:"+base+"USDT")}&interval=60&theme=dark&style=1&hideideas=1&hidesidetoolbar=1`;
}
document.getElementById("obPair").addEventListener("change",()=>{
  loadOrderBook(true); loadChart();
});

/* top 10 */
function formatMoneyUSD(n){
  return "$" + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
}
function formatPct(p){
  const v=Number(p||0);
  const sign=v>=0?"+":"";
  return sign + v.toFixed(2) + "%";
}
async function loadTop10MajorCrypto(){
  const msg=document.getElementById("top10Msg");
  const list=document.getElementById("top10List");
  msg.textContent="Loading top coins‚Ä¶";

  try{
    const res = await fetch("https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false&price_change_percentage=24h");
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error("bad");

    msg.textContent="";
    list.innerHTML=data.map(c=>{
      const chg=Number(c.price_change_percentage_24h||0);
      const cls=chg>=0?"up":"down";
      const arrow=chg>=0?"‚ñ≤":"‚ñº";
      return `
        <div class="top10Item">
          <div class="coinLeft">
            <div class="coinLogo"><img src="${c.image}" alt=""></div>
            <div class="coinMeta">
              <div class="coinName">${c.name}</div>
              <div class="coinSym">${String(c.symbol||"").toUpperCase()}</div>
            </div>
          </div>
          <div class="coinRight">
            <div class="coinPrice">${formatMoneyUSD(c.current_price)}</div>
            <div class="chg ${cls}">${arrow} ${formatPct(chg)}</div>
          </div>
        </div>
      `;
    }).join("");
  }catch{
    msg.textContent="Failed to load top coins.";
    list.innerHTML="";
  }
}
function startTop10Refresh(){
  if(top10Timer) clearInterval(top10Timer);
  loadTop10MajorCrypto();
  top10Timer=setInterval(loadTop10MajorCrypto, 30000);
}

/* logout */
async function logout(){
  await supabaseClient.auth.signOut();
  window.location.replace("login.html");
}

/* init */
function initWithUser(user){
  currentUserEmail=user.email;
  currentUserId=user.id;

  setGreeting();
  startClock();
  document.getElementById("userIdChip").innerText="ID: "+currentUserId.slice(0,6).toUpperCase();

  loadBalance();
  loadActivePlan();

  loadOrderBook(true);
  loadChart();
  startOrderAutoRefresh();

  startTop10Refresh();
}
</script>

</body>
</html>
