<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Investment Plans</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#020617;color:#e5e7eb;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid #1e293b;margin-bottom:14px}
button{border:none;padding:10px 14px;border-radius:10px;font-weight:900;cursor:pointer;background:#38bdf8;color:#020617}
.box{border:1px solid #1e293b;border-radius:12px;padding:14px;background:#020617;margin-bottom:16px}
h2{margin:0;font-size:18px}
.small{color:#94a3b8;font-size:12px;margin-top:6px}
.ok{color:#22c55e}
.err{color:#f87171}
.grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px}
.plan{border:1px solid #1e293b;border-radius:14px;padding:14px;background:#020617}
.planTitle{font-size:18px;font-weight:1000}
.row{display:flex;justify-content:space-between;gap:10px;margin-top:10px}
.tag{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;background:#0b1224;border:1px solid #1e293b}
input{width:100%;padding:12px;margin-top:10px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb}
.start{width:100%;margin-top:12px;background:#22c55e}
.card{border:1px solid #1e293b;border-radius:12px;padding:12px;margin-top:12px}
a{color:#38bdf8;text-decoration:none;font-weight:900}
</style>
</head>

<body>

<header>
  <strong>Investment Plans</strong>
  <button onclick="goDashboard()">Dashboard</button>
</header>

<div class="box">
  <h2>My Active Plan</h2>
  <div id="activeMsg" class="small">Loading…</div>
  <div id="activePlan"></div>
</div>

<div class="box">
  <h2>Choose a Plan</h2>
  <div class="small">Start an investment plan with defined ROI and duration</div>

  <div class="grid" id="plansList"></div>

  <div id="msg" class="small"></div>
</div>

<script>
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let currentUserEmail="";

const PLANS = [
  {name:"Silver", roi:15, duration:7, min:100, max:999},
  {name:"Gold", roi:35, duration:14, min:1000, max:4999},
  {name:"Platinum", roi:70, duration:30, min:5000, max:100000}
];

init();

function goDashboard(){
  window.location.href="user-dashboard.html";
}

function money(n){
  return "$" + Number(n||0).toFixed(2);
}

async function init(){
  const { data:userData } = await supabaseClient.auth.getUser();
  if(!userData.user){
    document.body.innerHTML="<h2 style='color:white'>You must login first.</h2>";
    return;
  }

  currentUserEmail=userData.user.email;

  renderPlans();
  loadActivePlan();
}

function renderPlans(){
  const wrapper=document.getElementById("plansList");
  wrapper.innerHTML="";

  PLANS.forEach((p,i)=>{
    wrapper.innerHTML += `
      <div class="plan">
        <div class="planTitle">${p.name} Plan</div>

        <div class="row">
          <span class="tag">ROI: ${p.roi}%</span>
          <span class="tag">Duration: ${p.duration} days</span>
        </div>

        <div class="row">
          <span class="tag">Min: ${money(p.min)}</span>
          <span class="tag">Max: ${money(p.max)}</span>
        </div>

        <input type="number" id="amount-${i}" placeholder="Enter amount to invest (${p.min} - ${p.max})"/>

        <button class="start" onclick="startPlan(${i})">Start ${p.name}</button>
      </div>
    `;
  });
}

async function loadActivePlan(){
  const activeMsg=document.getElementById("activeMsg");
  const activePlan=document.getElementById("activePlan");

  const { data, error } = await supabaseClient
    .from("investment_plans")
    .select("*")
    .eq("user_email", currentUserEmail)
    .in("status", ["active","pending"])
    .order("created_at", {ascending:false})
    .limit(1);

  if(error){
    activeMsg.innerHTML="<span class='err'>"+error.message+"</span>";
    return;
  }

  if(!data || data.length===0){
    activeMsg.innerHTML="<span class='err'>No active plan.</span>";
    activePlan.innerHTML="";
    return;
  }

  const plan=data[0];

  activeMsg.innerHTML="<span class='ok'>Active plan found ✅</span>";

  const expectedReturn = Number(plan.amount||0) + (Number(plan.amount||0) * (Number(plan.roi_percent||0)/100));

  activePlan.innerHTML=`
    <div class="card">
      <strong>${plan.plan_name}</strong><br><br>
      <div class="small">Amount: <strong>${money(plan.amount)}</strong></div>
      <div class="small">ROI: <strong>${plan.roi_percent}%</strong></div>
      <div class="small">Duration: <strong>${plan.duration_days} days</strong></div>
      <div class="small">Status: <strong class="ok">${plan.status}</strong></div>
      <div class="small" style="margin-top:10px">Expected Return: <strong>${money(expectedReturn)}</strong></div>
    </div>
  `;
}

async function startPlan(index){
  const msg=document.getElementById("msg");
  msg.innerHTML="Starting plan…";

  const plan=PLANS[index];
  const amount=Number(document.getElementById(`amount-${index}`).value||0);

  if(amount < plan.min || amount > plan.max){
    msg.innerHTML=`<span class="err">Amount must be between ${money(plan.min)} and ${money(plan.max)}</span>`;
    return;
  }

  // check if user has existing active plan
  const { data:existing } = await supabaseClient
    .from("investment_plans")
    .select("*")
    .eq("user_email", currentUserEmail)
    .in("status", ["active","pending"]);

  if(existing && existing.length>0){
    msg.innerHTML="<span class='err'>You already have an active plan. Contact support to upgrade.</span>";
    return;
  }

  // create plan record
  const { error } = await supabaseClient.from("investment_plans").insert([{
    user_email: currentUserEmail,
    plan_name: plan.name,
    amount: amount,
    roi_percent: plan.roi,
    duration_days: plan.duration,
    status: "pending"
  }]);

  if(error){
    msg.innerHTML="<span class='err'>"+error.message+"</span>";
    return;
  }

  msg.innerHTML="<span class='ok'>Plan started ✅ Waiting for admin approval</span>";
  loadActivePlan();
}
</script>

</body>
</html>
